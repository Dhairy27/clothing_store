<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Clothy</title>
  <link rel="stylesheet" href="style.css">

</head>

<body>

  <nav class="navbar">
    <h2>Clothy</h2>
    <div>
      <a href="index.html">Home</a>
      <a href="collection.html">Collection</a>
      <a href="cart.html" class="cart-link">
        Cart
        <span id="cart-count" class="cart-count">0</span>
      </a>
      <a href="admin-login.html" class="admin-btn" style="display: none;">Admin</a>

      <!-- User Profile Dropdown -->
      <div class="profile-dropdown" id="user-profile-dropdown" style="display: none;">
        <button class="profile-btn" onclick="toggleUserProfileDropdown()">
          <span class="profile-avatar">üë§</span>
          <span id="user-profile-username">User</span>
          <span class="dropdown-arrow">‚ñº</span>
        </button>
        <div id="user-profile-menu" class="profile-menu">
          <div class="profile-header">
            <div class="profile-info">
              <h4 id="user-profile-name">User Name</h4>
              <p id="user-profile-email">user@example.com</p>
            </div>
          </div>
          <div class="profile-actions">
            <a href="profile.html" class="profile-link view-profile">üìã View Profile</a>
            <a href="#" onclick="userLogout()" class="profile-link logout">üö™ Logout</a>
          </div>
        </div>
      </div>

      <a href="login.html" id="login-link" class="login-btn-special">Login</a>
    </div>
  </nav>

  <div class="checkout-container">
    <!-- Shipping Address Selection -->
    <div class="checkout-section">
      <h2>üè† Shipping Address</h2>
      <div id="saved-addresses-container">
        <div class="loading-addresses">Loading saved addresses...</div>
      </div>

      <div class="address-actions" style="margin-top: 15px;">
        <button type="button" class="btn-secondary" onclick="addNewAddress()">+ Add New Address</button>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="checkout-section">
      <h2>üì¶ Order Summary</h2>
      <div class="order-summary">
        <div id="checkout-items"></div>
        <div class="order-total">
          <span>Total:</span>
          <span id="checkout-total">‚Çπ0</span>
        </div>
      </div>
    </div>

    <!-- Payment Information -->
    <div class="checkout-section">
      <h2>üí≥ Payment Information</h2>

      <!-- Payment Methods -->
      <div class="payment-methods">
        <label class="payment-method">
          <input type="radio" name="paymentMethod" value="cod" checked>
          <span>üíµ Cash on Delivery</span>
        </label>
        <label class="payment-method">
          <input type="radio" name="paymentMethod" value="card">
          <span>üí≥ Credit/Debit Card</span>
        </label>
        <label class="payment-method">
          <input type="radio" name="paymentMethod" value="upi">
          <span>üì± UPI Payment</span>
        </label>
      </div>

      <!-- UPI Payment Details (shown when UPI is selected) -->
      <div id="upi-payment-details"
        style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
        <h4 style="margin-bottom: 15px; color: #333;">üì± UPI Payment Details</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
          <!-- UPI Details -->
          <div style="background: white; padding: 15px; border-radius: 6px;">
            <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">UPI ID:</div>
            <div style="font-size: 18px; color: #333; font-weight: 500;">6352047745@slc</div>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">Name: Janjarukia Dhairy Alpeshbhai</div>
          </div>

          <!-- QR Code -->
          <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
            <div style="font-weight: 600; color: #667eea; margin-bottom: 10px;">Scan QR Code</div>
            <div id="upi-qr-code"
              style="width: 150px; height: 150px; margin: 0 auto; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 2px solid #ddd;">
              <!-- QR Code will be generated here -->
              <div style="color: #666; font-size: 12px; text-align: center;">
                QR Code<br>Loading...
              </div>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">Scan with any UPI app</div>
          </div>
        </div>

        <div class="form-group">
          <label for="utr-number" style="font-weight: 600; color: #555;">UTR Number (12-digit Transaction ID)</label>
          <input type="text" id="utr-number" placeholder="Enter 12-digit UTR number" maxlength="12"
            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
          <small style="color: #666; font-size: 12px;">Please enter the 12-digit UTR number after completing the UPI
            payment</small>
        </div>
      </div>

      <!-- Place Order Button -->
      <button type="button" class="place-order-btn" onclick="placeOrder()">
        Place Order
      </button>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <div class="footer-brand">
        <h2>Clothy</h2>
        <p>Elevating your everyday style with premium quality and modern aesthetics. Designed for the bold, crafted for
          comfort.</p>
        <div class="social-links">
          <a href="#" class="social-link" title="Instagram">üì∑</a>
          <a href="#" class="social-link" title="Twitter">üê¶</a>
          <a href="#" class="social-link" title="Facebook">üìò</a>
        </div>
      </div>

      <div class="footer-column">
        <h3>Shop</h3>
        <ul>
          <li><a href="collection.html">All Products</a></li>
          <li><a href="collection.html?category=Men">Men</a></li>
          <li><a href="collection.html?category=Women">Women</a></li>
          <li><a href="collection.html?category=Accessories">Accessories</a></li>
        </ul>
      </div>

      <div class="footer-column">
        <h3>Company</h3>
        <ul>
          <li><a href="#">About Us</a></li>
          <li><a href="#">Careers</a></li>
          <li><a href="#">Sustainability</a></li>
          <li><a href="#">Blog</a></li>
        </ul>
      </div>

      <div class="footer-column">
        <h3>Support</h3>
        <ul>
          <li><a href="#">Help Center</a></li>
          <li><a href="#">Shipping & Returns</a></li>
          <li><a href="#">Size Guide</a></li>
          <li><a href="#">Contact Us</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-bottom">
      <p>¬© 2026 Clothy | Fashion Redefined</p>
      <div class="footer-bottom-links">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Service</a>
        <a href="#">Cookie Policy</a>
      </div>
    </div>
  </footer>

  <script src="script.js"></script>
  <script>
    // Load checkout data
    document.addEventListener('DOMContentLoaded', function () {
      checkUserLoginStatus();
      loadCheckoutItems();
      updateCartCount();
      loadSavedAddresses();

      // Debug: Check user data
      debugUserData();

      // Add event listener for payment method changes
      const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
      paymentMethods.forEach(method => {
        method.addEventListener('change', function () {
          loadCheckoutItems();
          toggleUPIDetails();
        });
      });
    });

    // Function to show/hide UPI details (moved outside DOMContentLoaded)
    function toggleUPIDetails() {
      const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
      if (!selectedMethod) return;

      const upiDetails = document.getElementById('upi-payment-details');

      if (selectedMethod.value === 'upi') {
        upiDetails.style.display = 'block';
        generateUPIQRCode();
      } else {
        upiDetails.style.display = 'none';
      }
    }

    // Function to generate UPI QR code (moved outside DOMContentLoaded)
    function generateUPIQRCode() {
      const qrContainer = document.getElementById('upi-qr-code');
      if (!qrContainer) return;

      // Get current total amount
      const totalAmount = getTotalPrice();
      const finalAmount = document.querySelector('input[name="paymentMethod"]:checked').value === 'cod' ?
        totalAmount + 10 : totalAmount;

      // UPI QR code data format: upi://pay?pa=UPI_ID&pn=NAME&am=AMOUNT&cu=CURRENCY
      const upiId = '6352047745@slc';
      const payeeName = 'Janjarukia Dhairy Alpeshbhai';
      const amount = finalAmount.toString(); // Include the total amount
      const currency = 'INR';

      const upiUrl = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=${currency}`;

      // Generate actual QR code using external service
      const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(upiUrl)}`;

      // Reset container and create proper structure
      qrContainer.innerHTML = '';

      // Create QR image element
      const qrImage = document.createElement('img');
      qrImage.src = qrImageUrl;
      qrImage.alt = 'UPI QR Code';
      qrImage.style.cssText = 'width: 150px; height: 150px; border-radius: 8px; border: 2px solid #ddd; object-fit: cover; display: block;';

      // Create fallback container
      const fallbackDiv = document.createElement('div');
      fallbackDiv.style.cssText = 'width: 150px; height: 150px; background: white; border: 2px solid #ddd; border-radius: 8px; margin: 0 auto; display: none; align-items: center; justify-content: center; position: relative;';
      fallbackDiv.innerHTML = `
      <div style="position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: #333;"></div>
      <div style="position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; background: #333;"></div>
      <div style="position: absolute; bottom: 10px; left: 10px; width: 30px; height: 30px; background: #333;"></div>
      <div style="position: absolute; top: 50px; left: 50px; width: 50px; height: 50px; background: #333; border-radius: 4px;"></div>
      <div style="position: absolute; top: 60px; left: 60px; width: 30px; height: 30px; background: white;"></div>
      <div style="position: absolute; top: 70px; left: 70px; width: 10px; height: 10px; background: #333;"></div>
      <div style="position: absolute; bottom: 5px; left: 0; right: 0; text-align: center; font-size: 8px; color: #666; background: rgba(255,255,255,0.9); padding: 2px;">
        QR
      </div>
    `;

      // Add error handling to image
      qrImage.onerror = function () {
        qrImage.style.display = 'none';
        fallbackDiv.style.display = 'flex';
      };

      // Append elements to container (removed amount display)
      qrContainer.appendChild(qrImage);
      qrContainer.appendChild(fallbackDiv);
    }

    // Debug function to check user data
    function debugUserData() {
      console.log('=== User Data Debug ===');
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');

      console.log('Token exists:', !!token);
      console.log('User data raw:', userData);

      if (userData) {
        try {
          const parsed = JSON.parse(userData);
          console.log('User data parsed:', parsed);
          console.log('User _id:', parsed._id);
          console.log('User email:', parsed.email);
        } catch (error) {
          console.error('Error parsing user data:', error);
        }
      } else {
        console.warn('No user data found in localStorage or sessionStorage');
      }
      console.log('=====================');
    }

    // Load cart items for checkout
    function loadCheckoutItems() {
      const checkoutItems = document.getElementById('checkout-items');
      const checkoutTotal = document.getElementById('checkout-total');

      if (cart.length === 0) {
        checkoutItems.innerHTML = '<p style="text-align: center; color: #666;">Your cart is empty</p>';
        checkoutTotal.textContent = '‚Çπ0';
        document.querySelector('.place-order-btn').disabled = true;
        return;
      }

      let itemsHTML = '';
      let total = 0;

      cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        const sizeText = item.size ? ` (Size: ${item.size})` : '';
        itemsHTML += `
        <div class="order-item">
          <div>
            <strong>${item.name}${sizeText}</strong><br>
            <small>Quantity: ${item.quantity} √ó ‚Çπ${item.price}</small>
          </div>
          <span>‚Çπ${itemTotal}</span>
        </div>
      `;
      });

      // Get selected payment method
      const paymentMethodElement = document.querySelector('input[name="paymentMethod"]:checked');
      const paymentMethod = paymentMethodElement ? paymentMethodElement.value : 'cod';

      let finalTotal = total;

      if (paymentMethod === 'cod') {
        finalTotal = total + 10; // Add ‚Çπ10 extra charge
        console.log('Cash on Delivery selected - Adding ‚Çπ10 extra charge');

        // Add cash on delivery charge as a separate item
        itemsHTML += `
        <div class="order-item" style="background: #fff3cd; border-left: 3px solid #ffc107;">
          <div>
            <strong>üíµ Cash on Delivery Charge</strong>
          </div>
          <span style="color: #856404;">‚Çπ10</span>
        </div>
      `;
      }

      checkoutItems.innerHTML = itemsHTML;
      checkoutTotal.textContent = '‚Çπ' + finalTotal;

      // Regenerate QR code if UPI is selected
      if (paymentMethod === 'upi') {
        generateUPIQRCode();
      }
    }

    // Place order function
    async function placeOrder() {
      if (cart.length === 0) {
        showNotification('Your cart is empty!');
        return;
      }

      // Get authentication token
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      if (!token) {
        showNotification('Please login to place an order');
        return;
      }

      // Get user data (no validation - just get it)
      const userData = JSON.parse(localStorage.getItem('userData') || sessionStorage.getItem('userData') || '{}');

      // Validate shipping address selection
      if (!selectedAddressId) {
        showNotification('Please select a shipping address');
        return;
      }

      // Get selected shipping address
      const shippingAddress = savedAddresses.find(addr => addr._id === selectedAddressId);
      if (!shippingAddress) {
        showNotification('Invalid shipping address selected');
        return;
      }

      // Validate payment method
      const paymentMethodElement = document.querySelector('input[name="paymentMethod"]:checked');
      if (!paymentMethodElement) {
        showNotification('Please select a payment method');
        return;
      }

      const paymentMethod = paymentMethodElement.value;

      // Validate UTR for UPI payments
      let utrNumber = null;
      if (paymentMethod === 'upi') {
        utrNumber = document.getElementById('utr-number').value.trim();
        if (!utrNumber) {
          showNotification('Please enter UTR number for UPI payment');
          return;
        }
        if (utrNumber.length !== 12 || !/^\d+$/.test(utrNumber)) {
          showNotification('UTR number must be exactly 12 digits');
          return;
        }
      }

      const totalAmount = getTotalPrice();
      if (totalAmount <= 0) {
        showNotification('Invalid total amount');
        return;
      }

      // Add extra charge for Cash on Delivery
      let finalTotalAmount = totalAmount;

      if (paymentMethod === 'cod') {
        finalTotalAmount = totalAmount + 10; // Add ‚Çπ10 extra charge
        console.log('Cash on Delivery selected - Adding ‚Çπ10 extra charge');
      }

      const orderData = {
        userId: userData._id || userData.id,
        items: cart.map(item => ({
          productId: item.productId || item.id, // Use productId if available, fallback to id (which might be wrong for legacy items)
          name: item.name,
          price: item.price,
          quantity: item.quantity,
          size: item.size || null // Include selected size
        })),
        shippingAddressId: shippingAddress._id, // Save address ID instead of full address
        paymentMethod: paymentMethod,
        totalAmount: finalTotalAmount,
        status: 'pending',
        createdAt: new Date(),
        utrNumber: utrNumber // Add UTR number for UPI payments
      };

      console.log('Order data being sent:', orderData);
      console.log('Selected address:', shippingAddress);
      console.log('Cart items:', cart);
      console.log('User data:', userData);

      try {
        // Disable button during processing
        const placeOrderBtn = document.querySelector('.place-order-btn');
        placeOrderBtn.disabled = true;
        placeOrderBtn.textContent = 'Processing...';

        // Send order to MongoDB via API
        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(orderData)
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);

        if (!response.ok) {
          const errorText = await response.text();
          console.log('Error response:', errorText);
          throw new Error(errorText || 'Failed to place order');
        }

        const result = await response.json();
        console.log('Order created successfully:', result);

        // Clear local cart
        cart = [];
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();

        // Show success message
        showNotification(`üéâ Order placed successfully! Order ID: ${result.orderId}`);

        // Redirect to home page after delay
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);

      } catch (error) {
        console.error('Error placing order:', error);
        showNotification('‚ùå Failed to place order: ' + error.message);

        // Re-enable button
        const placeOrderBtn = document.querySelector('.place-order-btn');
        placeOrderBtn.disabled = false;
        placeOrderBtn.textContent = 'Place Order';
      }
    }

    // Address Management Functions
    let selectedAddressId = null;
    let savedAddresses = [];

    async function loadSavedAddresses() {
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      if (!token) return;

      try {
        const response = await fetch('/api/user/addresses', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (response.ok) {
          savedAddresses = await response.json();
          displaySavedAddresses();
        } else {
          const error = await response.json();
          console.error('Failed to load addresses:', error);
        }
      } catch (error) {
        console.error('Error loading addresses:', error);
      }
    }

    function displaySavedAddresses() {
      const container = document.getElementById('saved-addresses-container');

      if (savedAddresses.length === 0) {
        container.innerHTML = `
        <div class="no-addresses">
          <div style="font-size: 48px; margin-bottom: 15px;">üè†</div>
          <p>No saved addresses</p>
          <p>Click "Add New Address" to create one</p>
        </div>
      `;
        return;
      }

      let addressesHTML = '';
      savedAddresses.forEach((address, index) => {
        const isSelected = selectedAddressId === address._id;
        const typeIcons = {
          'home': 'üè†',
          'work': 'üè¢',
          'other': 'üìç'
        };

        addressesHTML += `
        <div class="address-card ${isSelected ? 'selected' : ''}" onclick="selectAddress('${address._id}')" data-address-id="${address._id}">
          <div class="address-header">
            <div>
              <span class="address-type">${address.name} (${address.type})</span>
              ${address.isDefault ? '<span class="address-default">Default</span>' : ''}
            </div>
          </div>
          <div class="address-details">
            ${address.house ? `<div style="font-weight: 600; color: #333;">${address.house}</div>` : ''}
            <div>${address.street}</div>
            <div>${address.city}, ${address.state} ${address.zipCode}</div>
            <div>${address.country}</div>
            ${address.phone ? `<div>${address.phone}</div>` : ''}
            ${address.email ? `<div>${address.email}</div>` : ''}
          </div>
        </div>
      `;
      });

      container.innerHTML = addressesHTML;
    }

    function selectAddress(addressId) {
      // Remove previous selection
      document.querySelectorAll('.address-card').forEach(card => {
        card.classList.remove('selected');
      });

      // Add selection to clicked card
      const selectedCard = document.querySelector(`[data-address-id="${addressId}"]`);
      if (selectedCard) {
        selectedCard.classList.add('selected');
      }

      selectedAddressId = addressId;

      // Prefill billing form with selected address
      const address = savedAddresses.find(addr => addr._id === addressId);
      if (address) {
        prefillAddressForm(address);
      }

      // Prefill shipping address when selected
      if (address) {
        // Address is already selected, no need to prefill form
      }
    }


    function addNewAddress() {
      // Redirect to profile page to add new address
      showNotification('Redirecting to profile page to add new address...');
      setTimeout(() => {
        window.location.href = 'profile.html#addresses';
      }, 1500);
    }

  </script>

</body>

</html>