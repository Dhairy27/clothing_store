<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Clothy</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <nav class="navbar">
    <h2>Clothy Admin</h2>
    <div>
      <a href="index.html">Store</a>
      <a href="collection.html">Collection</a>

      <a href="cart.html" class="cart-link">
        Cart
        <span id="cart-count" class="cart-count">0</span>
      </a>

      <a href="admin.html" class="admin-active">Admin Panel</a>

      <!-- Profile Dropdown -->
      <div class="profile-dropdown">
        <button class="profile-btn" onclick="toggleProfileDropdown()">
          <span class="profile-avatar">üë§</span>
          <span id="profile-username">Admin</span>
          <span class="dropdown-arrow">‚ñº</span>
        </button>
        <div id="profile-menu" class="profile-menu">
          <div class="profile-header">
            <div class="profile-info">
              <h4 id="profile-name">Admin User</h4>
              <p id="profile-email">admin@clothy.com</p>
            </div>
          </div>
          <div class="profile-actions">
            <a href="#" onclick="showProfileDetails()" class="profile-link">üìã View Profile</a>
            <a href="#" onclick="adminLogout()" class="profile-link logout">üö™ Logout</a>
          </div>
        </div>
      </div>

    </div>
  </nav>

  <section class="admin-page">
    <div class="admin-container">
      <div class="admin-header">
        <h1>üõçÔ∏è Admin Dashboard</h1>
        <p>Manage your clothing store inventory and orders</p>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon products-icon">üëï</div>
          <div class="stat-info">
            <h3 id="total-products">0</h3>
            <p>Total Products</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon users-icon">üë•</div>
          <div class="stat-info">
            <h3 id="total-users">0</h3>
            <p>Total Users</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orders-icon">üì¶</div>
          <div class="stat-info">
            <h3 id="total-orders">0</h3>
            <p>Total Orders</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon revenue-icon">üí∞</div>
          <div class="stat-info">
            <h3 id="total-revenue">‚Çπ0</h3>
            <p>Total Revenue</p>
          </div>
        </div>
      </div>

      <!-- Admin Tabs -->
      <div class="admin-tabs">
        <button class="tab-btn active" onclick="showTab('products')">Products</button>
        <button class="tab-btn" onclick="showTab('groups')">Groups</button>
        <button class="tab-btn" onclick="showTab('users')">Users</button>
        <button class="tab-btn" onclick="showTab('orders')">Orders</button>
        <button class="tab-btn" onclick="showTab('analytics')">Analytics</button>
      </div>

      <!-- Products Tab -->
      <div id="products-tab" class="tab-content active">
        <div class="tab-header">
          <h2>Product Management</h2>
          <div class="tab-actions">
            <button class="admin-btn secondary" onclick="groupSelectedProducts()" id="group-products-btn"
              style="display: none;">
              üîó Group Selected (<span id="selected-count">0</span>)
            </button>
            <button class="admin-btn secondary" onclick="refreshProducts()">üîÑ Refresh</button>
            <button class="admin-btn secondary" onclick="exportProducts()">üìä Export CSV</button>
            <button class="admin-btn primary" onclick="showAddProductModal()">+ Add Product</button>
          </div>
        </div>
        <div class="search-bar">
          <input type="text" id="product-search" placeholder="Search products..." onkeyup="searchProducts()">
          <select id="category-filter" onchange="filterProducts()">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="products-table-container">
          <table class="admin-table" id="products-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all-products" onchange="toggleAllProducts()"></th>
                <th>ID</th>
                <th>Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Image</th>
                <th>Linked (Group)</th>
                <th>Description</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="products-tbody">
              <!-- Products will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Groups Tab -->
      <div id="groups-tab" class="tab-content">
        <div class="tab-header">
          <h2>Product Groups</h2>
          <div class="tab-actions">
            <button class="admin-btn secondary" onclick="unlinkSelectedGroupProducts()" id="unlink-products-btn"
              style="display: none; background-color: #ef4444; color: white; border: none;">
              ‚õìÔ∏è Unlink Selected (<span id="group-selected-count">0</span>)
            </button>
            <button class="admin-btn secondary" onclick="displayGroups()">üîÑ Refresh</button>
          </div>
        </div>
        <div class="groups-container" id="groups-container">
          <!-- Groups will be rendered here -->
        </div>
      </div> <!-- End groups-tab -->

      <!-- Users Tab -->
      <div id="users-tab" class="tab-content">
        <div class="tab-header">
          <h2>User Management</h2>
          <div class="tab-actions">
            <button class="admin-btn secondary" onclick="refreshUsers()">üîÑ Refresh</button>
            <button class="admin-btn secondary" onclick="exportUsers()">üìä Export CSV</button>
            <button class="btn-primary" onclick="showAddUserModal()">+ Add User</button>
          </div>
        </div>
        <div class="search-bar">
          <input type="text" id="user-search" placeholder="Search users..." onkeyup="searchUsers()">
        </div>
        <div class="users-table-container">
          <table class="admin-table" id="users-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Type</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-tbody">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Orders Tab -->
      <div id="orders-tab" class="tab-content">
        <div class="tab-header">
          <h2>Order Management</h2>
          <div class="tab-actions">
            <button class="admin-btn secondary" onclick="refreshOrders()">üîÑ Refresh</button>
            <button class="admin-btn secondary" onclick="exportOrders()">üìä Export CSV</button>
            <button class="admin-btn primary" onclick="bulkUpdateOrders()" id="bulk-update-btn"
              style="display: none;">üìù Update Selected</button>
          </div>
        </div>
        <div class="search-bar">
          <input type="text" id="order-search" placeholder="Search orders..." onkeyup="searchOrders()">
          <select id="status-filter" onchange="filterOrders()">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        <div class="orders-table-container">
          <table class="admin-table" id="orders-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all-orders" onchange="toggleAllOrders()"></th>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Shipping Address</th>
                <th>Payment Method</th>
                <th>Total</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="orders-tbody">
              <!-- Orders will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Analytics Tab -->
      <div id="analytics-tab" class="tab-content">
        <div class="tab-header">
          <h2>Analytics Dashboard</h2>
        </div>
        <div class="analytics-grid">
          <div class="chart-card">
            <h3>Sales by Category</h3>
            <div class="chart-placeholder">
              <div class="chart-bar" style="width: 80%; background: #667eea;">T-Shirts: 40%</div>
              <div class="chart-bar" style="width: 60%; background: #764ba2;">Shirts: 30%</div>
              <div class="chart-bar" style="width: 60%; background: #f093fb;">Jeans: 30%</div>
            </div>
          </div>
          <div class="chart-card">
            <h3>Recent Activity</h3>
            <div class="activity-list">
              <div class="activity-item">New order received</div>
              <div class="activity-item">New product added</div>
              <div class="activity-item">User registered</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Add Product Modal -->
  <div class="modal" id="add-product-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Product</h3>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <form class="modal-form" onsubmit="addProduct(event)">
        <div class="form-group">
          <label for="product-name">Product Name</label>
          <input type="text" id="product-name" required>
        </div>
        <div class="form-group">
          <label for="product-category">Category</label>
          <div class="category-button-wrapper">
            <select id="product-category" required style="flex: 1;">
              <option value="">Select Category</option>
            </select>
            <button type="button" class="btn-secondary" onclick="showAddCategoryModal()">New Category</button>
          </div>
        </div>
        <div class="form-group">
          <label for="product-price">Price (‚Çπ)</label>
          <input type="number" id="product-price" min="0" step="1" required>
        </div>
        <div class="form-group">
          <label>Stock Management</label>
          <div class="stock-management">
            <!-- Stock Type Toggle Removed - Defaulting to Size-wise Stock -->
            <input type="hidden" name="stock-type" value="multiple">

            <div id="multiple-stock" class="stock-input-group">
              <label>Size-wise Stock</label>
              <div id="size-stock-container" class="size-stock-container">
                <div class="size-stock-row">
                  <input type="text" placeholder="Size (e.g., S, M, L, XL)" class="size-name">
                  <input type="number" placeholder="Stock" min="0" step="1" class="size-quantity">
                  <button type="button" onclick="addSizeRow()" class="btn-add-size">+ Add Size</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="product-description">Description</label>
          <textarea id="product-description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="product-images">Product Images (Upload)</label>
          <input type="file" id="product-images" multiple accept="image/*">
        </div>
        <div class="form-group">
          <label for="product-image">Image Keyword/Path (Optional/Legacy)</label>
          <input type="text" id="product-image" placeholder="Enter keyword (e.g. 'shirt') or external URL">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn-primary">Add Product</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div class="modal" id="edit-product-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Product</h3>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <form class="modal-form" onsubmit="updateProduct(event)">
        <input type="hidden" id="edit-product-id">
        <div class="form-group">
          <label for="edit-product-name">Product Name</label>
          <input type="text" id="edit-product-name" required>
        </div>
        <div class="form-group">
          <label for="edit-product-category">Category</label>
          <select id="edit-product-category" required>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-product-price">Price (‚Çπ)</label>
          <input type="number" id="edit-product-price" min="0" step="1" required>
        </div>
        <div class="form-group">
          <label>Stock Management</label>
          <div class="stock-management">
            <!-- Stock Type Toggle Removed - Defaulting to Size-wise Stock -->
            <input type="hidden" name="edit-stock-type" value="multiple">

            <div id="edit-multiple-stock" class="stock-input-group">
              <label>Size-wise Stock</label>
              <div id="edit-size-stock-container" class="size-stock-container">
                <!-- Size rows will be added here dynamically -->
              </div>
              <button type="button" onclick="addEditSizeRow()" class="btn-add-size" style="margin-top: 10px;">+ Add
                Size</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="edit-product-description">Description</label>
          <textarea id="edit-product-description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Current Images</label>
          <div id="edit-current-images" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
            <!-- Images will be populated here -->
          </div>
        </div>
        <div class="form-group">
          <label for="edit-product-images">Add New Images</label>
          <input type="file" id="edit-product-images" multiple accept="image/*">
        </div>
        <input type="hidden" id="edit-product-image">
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn-primary">Update Product</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Stock Modal -->
  <div class="modal" id="add-stock-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Stock</h3>
        <button class="close-btn" onclick="closeAddStockModal()">&times;</button>
      </div>
      <form class="modal-form" onsubmit="updateStock(event); return false;">
        <input type="hidden" id="add-stock-product-id">
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="add-stock-product-name" readonly style="background: #f8f9fa; color: #666;">
        </div>
        <div class="form-group">
          <label>Current Stock</label>
          <div id="current-stock-display"
            style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
            <!-- Current stock will be displayed here -->
          </div>
        </div>
        <div id="add-multiple-stock" class="stock-input-group">
          <label>Size-wise Stock Addition</label>
          <div id="add-size-stock-container">
            <!-- Size inputs will be dynamically added here -->
          </div>
          <button type="button" onclick="addSizeStockRow()" class="btn-secondary" style="margin-top: 10px;">+ Add
            Size</button>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeAddStockModal()">Cancel</button>
          <button type="submit" class="btn-primary">Add Stock</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Category Modal -->
  <div class="modal" id="add-category-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Category</h3>
        <button class="close-btn" onclick="closeCategoryModal()">&times;</button>
      </div>
      <form class="modal-form" onsubmit="addCategory(event)">
        <div class="form-group">
          <label for="category-name">Category Name</label>
          <input type="text" id="category-name" placeholder="e.g., Jackets, Shorts, Accessories" required>
        </div>
        <div class="form-group">
          <label for="category-description">Description (Optional)</label>
          <textarea id="category-description" rows="3" placeholder="Brief description of this category"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeCategoryModal()">Cancel</button>
          <button type="submit" class="btn-primary">Add Category</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add User Modal -->
  <div class="modal" id="add-user-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New User</h3>
        <button class="close-btn" onclick="closeUserModal()">&times;</button>
      </div>
      <form class="modal-form" onsubmit="addUser(event)">
        <div class="form-group">
          <label for="user-first-name">First Name</label>
          <input type="text" id="user-first-name" required>
        </div>
        <div class="form-group">
          <label for="user-last-name">Last Name</label>
          <input type="text" id="user-last-name" required>
        </div>
        <div class="form-group">
          <label for="user-email">Email</label>
          <input type="email" id="user-email" required>
        </div>
        <div class="form-group">
          <label for="user-phone">Phone</label>
          <input type="tel" id="user-phone" placeholder="1234567890">
        </div>
        <div class="form-group">
          <label for="user-password">Password</label>
          <input type="password" id="user-password" required>
        </div>
        <div class="form-group">
          <label for="user-type">User Type</label>
          <select id="user-type" required>
            <option value="user">User</option>
            <option value="admin">Admin</option>
            <option value="delivery">Delivery</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeUserModal()">Cancel</button>
          <button type="submit" class="btn-primary">Add User</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal" id="edit-user-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit User</h3>
        <button class="close-btn" onclick="closeEditUserModal()">&times;</button>
      </div>
      <form class="modal-form" onsubmit="updateUser(event)">
        <input type="hidden" id="edit-user-id">
        <div class="form-group">
          <label for="edit-user-first-name">First Name</label>
          <input type="text" id="edit-user-first-name" required>
        </div>
        <div class="form-group">
          <label for="edit-user-last-name">Last Name</label>
          <input type="text" id="edit-user-last-name" required>
        </div>
        <div class="form-group">
          <label for="edit-user-email">Email</label>
          <input type="email" id="edit-user-email" required>
        </div>
        <div class="form-group">
          <label for="edit-user-phone">Phone</label>
          <input type="tel" id="edit-user-phone" placeholder="1234567890">
        </div>
        <div class="form-group">
          <label for="edit-user-password">Password (leave empty to keep current)</label>
          <input type="password" id="edit-user-password" placeholder="Enter new password or leave empty">
        </div>
        <div class="form-group">
          <label for="edit-user-type">User Type</label>
          <select id="edit-user-type" required>
            <option value="user">User</option>
            <option value="admin">Admin</option>
            <option value="delivery">Delivery</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeEditUserModal()">Cancel</button>
          <button type="submit" class="btn-primary">Update User</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Link Colors Modal -->
  <div class="modal" id="link-colors-modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Link Product Colors</h3>
        <button class="close-btn" onclick="closeLinkColorsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="link-colors-product-id">
        <p class="modal-subtitle">Manage color variants for <strong id="link-colors-product-name">Product Name</strong>
        </p>

        <div class="product-search-container" style="position: relative; margin-bottom: 20px;">
          <label style="font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; display: block;">Search Product to
            Link</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="color-product-search" placeholder="Search by product name..."
              style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;"
              onkeyup="searchProductsForColor(this.value)">
          </div>
          <div id="color-search-results" class="search-results-dropdown"
            style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            <!-- Search results will appear here -->
          </div>
        </div>

        <div class="color-links-header"
          style="display: flex; gap: 10px; margin-bottom: 5px; font-size: 0.85rem; color: #64748b; font-weight: 500;">
          <span style="flex: 1;">Color Name (Label)</span>
          <span style="flex: 1.5;">Linked Product ID</span>
          <span style="width: 32px;"></span>
        </div>

        <div class="color-links-container" id="color-links-container">
          <!-- Dynamically added rows -->
        </div>

        <button type="button" class="btn-secondary" onclick="addLinkColorRow()" style="margin-top: 10px;">+ Add Empty
          Row</button>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="closeLinkColorsModal()">Cancel</button>
        <button type="button" class="btn-primary" onclick="saveLinkedColors()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- View Order Modal -->
  <div class="modal" id="view-order-modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>üì¶ Order Details</h3>
        <button class="close-btn" onclick="closeViewOrderModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="order-details-content">
          <!-- Order details will be loaded here -->
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="closeViewOrderModal()">Close</button>
        <button type="button" class="btn-primary" onclick="printOrderDetails()">üñ®Ô∏è Print</button>
      </div>
    </div>
  </div>

  <footer>
    <p>¬© 2026 Clothy Admin Panel | Fashion Management System</p>
  </footer>

  <script src="script.js?v=202501171112"></script>
  <script>
    // Cache busting - Admin panel updated on 2025-01-17 11:12
    console.log('Admin panel loaded with updated formatShippingAddress function - v202501171112');
    // Direct access to admin panel - no authentication required
    document.addEventListener('DOMContentLoaded', function () {
      // Setup admin browser close detection
      setupAdminPageBrowserCloseDetection();

      // Load admin data
      loadProfileInfo();
      loadAdminData();
      updateCartCount();
    });

    // Admin page browser close detection
    function setupAdminPageBrowserCloseDetection() {
      // Set a flag when page is loaded
      sessionStorage.setItem('adminPageSessionActive', 'true');

      // Clear admin sessions when browser is closing
      window.addEventListener('beforeunload', function (e) {
        // Only clear if this is actually browser close, not page navigation
        setTimeout(() => {
          // This won't execute if browser is closing
          sessionStorage.setItem('adminPageSessionActive', 'false');
        }, 100);

        // Check if we have any active session storage indicating browser is still open
        const isActive = sessionStorage.getItem('adminPageSessionActive');
        if (isActive === 'true') {
          // Browser is closing, clear all admin data
          sessionStorage.removeItem('adminToken');
          sessionStorage.removeItem('adminUser');
          sessionStorage.removeItem('adminLoggedIn');
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          localStorage.removeItem('adminLoggedIn');
        }
      });

      // Handle page visibility changes for admin
      document.addEventListener('visibilitychange', function () {
        if (document.visibilityState === 'visible') {
          // Page is visible again, update session state
          sessionStorage.setItem('adminPageSessionActive', 'true');
        }
      });
    }

    // Profile Management Functions
    function loadProfileInfo() {
      const adminUser = sessionStorage.getItem('adminUser') || 'Admin';

      document.getElementById('profile-username').textContent = adminUser;
      document.getElementById('profile-name').textContent = `Admin (${adminUser})`;
      document.getElementById('profile-email').textContent = 'admin@clothy.com';
    }

    function toggleProfileDropdown() {
      const dropdown = document.querySelector('.profile-dropdown');
      dropdown.classList.toggle('active');

      // Close dropdown when clicking outside
      document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target)) {
          dropdown.classList.remove('active');
          document.removeEventListener('click', closeDropdown);
        }
      });
    }

    function showProfileDetails() {
      const adminUser = sessionStorage.getItem('adminUser') || 'Admin';

      const profileInfo = `
    üë§ Admin Profile Information
    ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
    Username: ${adminUser}
    Email: admin@clothy.com
    Role: Administrator
    Status: Active
    Session: Active
    Login Time: ${new Date().toLocaleString()}
    
    üìä Admin Privileges:
    ‚Ä¢ Product Management
    ‚Ä¢ User Management  
    ‚Ä¢ Order Management
    ‚Ä¢ Category Management
    ‚Ä¢ Full System Access
  `;

      showNotification(profileInfo);

      // Close dropdown
      document.querySelector('.profile-dropdown').classList.remove('active');
    }

    // Admin logout function
    function adminLogout() {
      // Clear all admin session data
      sessionStorage.removeItem('adminToken');
      sessionStorage.removeItem('adminUser');
      sessionStorage.removeItem('adminLoggedIn');
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminUser');
      localStorage.removeItem('adminLoggedIn');

      // Also clear any regular user data to prevent profile dropdown from showing
      localStorage.removeItem('token');
      localStorage.removeItem('userData');
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      sessionStorage.removeItem('token');
      sessionStorage.removeItem('userData');
      sessionStorage.removeItem('authToken');
      sessionStorage.removeItem('user');

      // Clear cart as well
      cart = [];
      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount();

      showNotification('Admin logged out successfully!');
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 1500);
    }

    // Admin functionality
    let products = [];
    let users = [];
    let orders = [];

    // Helper to update category dropdowns
    function updateCategoryDropdownsWithData(categories) {
      const categoryFilter = document.getElementById('category-filter');
      const productCategory = document.getElementById('product-category');
      const editProductCategory = document.getElementById('edit-product-category');

      // Sort categories if not sorted
      // categories.sort((a, b) => a.name.localeCompare(b.name));

      if (categoryFilter) {
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(category => {
          categoryFilter.innerHTML += `<option value="${category.name}">${category.name}</option>`;
        });
      }

      if (productCategory) {
        productCategory.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(category => {
          productCategory.innerHTML += `<option value="${category.name}">${category.name}</option>`;
        });
      }

      if (editProductCategory) {
        editProductCategory.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(category => {
          editProductCategory.innerHTML += `<option value="${category.name}">${category.name}</option>`;
        });
      }
    }

    // Load data from MongoDB API
    async function loadAdminData() {
      try {
        console.log('Loading admin data...');

        // Load products from MongoDB (without authentication)
        // Add timestamp to prevent caching
        const productsResponse = await fetch(`/api/products?t=${Date.now()}`, { cache: "no-store" });
        products = await productsResponse.json();
        console.log('Products loaded:', products.length);

        // Load categories from MongoDB
        const categoriesResponse = await fetch(`/api/categories?t=${Date.now()}`, { cache: "no-store" });
        const categories = await categoriesResponse.json();
        console.log('Categories loaded:', categories.length);

        // Update category dropdowns with database categories
        updateCategoryDropdownsWithData(categories);

        // Load users from MongoDB (admin endpoint needed)
        console.log('Fetching users from /api/admin/users...');
        const usersResponse = await fetch('/api/admin/users');

        console.log('Users response status:', usersResponse.status);
        if (usersResponse.ok) {
          users = await usersResponse.json();
          console.log('Users loaded:', users.length);
          console.log('Users data:', users);
        } else {
          const errorData = await usersResponse.json();
          console.error('Failed to load users:', errorData);
        }

        // Load orders from MongoDB (admin endpoint needed)
        const ordersResponse = await fetch('/api/admin/orders');
        if (ordersResponse.ok) {
          orders = await ordersResponse.json();
          console.log('Orders loaded:', orders.length);
        }

        updateStats();
        displayProducts();
        displayUsers();
        displayOrders();
      } catch (error) {
        console.error('Error loading admin data:', error);
        showNotification('Failed to load admin data');
      }
    }


    function populateCategoryFilter() {
      const categoryFilter = document.getElementById('category-filter');
      const productCategory = document.getElementById('product-category');
      const editProductCategory = document.getElementById('edit-product-category');

      // Get unique categories from products
      const categories = [...new Set(products.map(p => p.category))].sort();

      // Update filter dropdown
      categoryFilter.innerHTML = '<option value="">All Categories</option>';
      categories.forEach(category => {
        categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
      });

      // Update add product modal dropdown
      productCategory.innerHTML = '';
      categories.forEach(category => {
        productCategory.innerHTML += `<option value="${category}">${category}</option>`;
      });

      // Update edit product modal dropdown
      editProductCategory.innerHTML = '';
      categories.forEach(category => {
        editProductCategory.innerHTML += `<option value="${category}">${category}</option>`;
      });
    }

    function updateStats() {
      document.getElementById('total-products').textContent = products.length;
      document.getElementById('total-users').textContent = users.length;
      document.getElementById('total-orders').textContent = orders.length;

      const totalRevenue = orders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      document.getElementById('total-revenue').textContent = `‚Çπ${totalRevenue.toLocaleString()}`;
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });

      // Remove active class from all buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // Add active class to clicked button
      event.target.classList.add('active');

      // Load data for specific tabs
      if (tabName === 'orders') {
        refreshOrders();
      } else if (tabName === 'products') {
        refreshProducts();
      } else if (tabName === 'groups') {
        displayGroups();
      } else if (tabName === 'users') {
        refreshUsers();
      } else if (tabName === 'analytics') {
        refreshAnalytics();
      }
    }

    async function refreshProducts() {
      try {
        const response = await fetch(`/api/products?t=${Date.now()}`, { cache: "no-store" });
        if (response.ok) {
          products = await response.json();
          displayProducts();
        }
      } catch (e) { console.error(e); }
    }

    async function refreshOrders() {
      try {
        console.log('Refreshing orders...');
        const response = await fetch('/api/admin/orders');
        if (response.ok) {
          orders = await response.json();
          console.log('Orders refreshed:', orders.length);
          displayOrders();
          updateStats(); // Use the main updateStats instead of missing updateOrderStats
        } else {
          console.error('Failed to refresh orders');
        }
      } catch (e) { console.error('Error refreshing orders:', e); }
    }

    async function refreshUsers() {
      try {
        console.log('Refreshing users...');
        const response = await fetch('/api/admin/users');
        if (response.ok) {
          users = await response.json();
          console.log('Users refreshed:', users.length);
          displayUsers();
          updateStats();
        } else {
          console.error('Failed to refresh users');
        }
      } catch (e) { console.error('Error refreshing users:', e); }
    }

    function refreshAnalytics() {
      loadAdminData();
    }

    function toggleAllProducts() {
      const checkbox = document.getElementById('select-all-products');
      const isChecked = checkbox.checked;

      selectedProductIds.clear();
      if (isChecked) {
        products.forEach(p => selectedProductIds.add(p._id || p.id));
      }

      displayProducts();
      updateGroupButtonState();
    }

    // Product Selection for Grouping
    const selectedProductIds = new Set();

    function toggleProductSelection(id) {
      if (selectedProductIds.has(id)) {
        selectedProductIds.delete(id);
      } else {
        selectedProductIds.add(id);
      }
      updateGroupButtonState();
    }

    // Group Selection State
    const selectedGroupProductIds = new Set();

    function toggleGroupSelection(id) {
      if (selectedGroupProductIds.has(id)) {
        selectedGroupProductIds.delete(id);
      } else {
        selectedGroupProductIds.add(id);
      }
      updateUnlinkButtonState();
    }

    function updateUnlinkButtonState() {
      const btn = document.getElementById('unlink-products-btn');
      const countSpan = document.getElementById('group-selected-count');

      if (!btn || !countSpan) return;

      const count = selectedGroupProductIds.size;
      countSpan.textContent = count;

      if (count > 0) {
        btn.style.display = 'inline-block';
      } else {
        btn.style.display = 'none';
      }
    }

    async function unlinkSelectedGroupProducts() {
      if (selectedGroupProductIds.size === 0) return;

      if (!confirm(`Are you sure you want to UNLINK these ${selectedGroupProductIds.size} products? They will be removed from their groups.`)) {
        return;
      }

      const btn = document.getElementById('unlink-products-btn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.textContent = 'Unlinking...';

      try {
        const response = await fetch('/api/admin/products/ungroup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productIds: Array.from(selectedGroupProductIds) })
        });

        if (response.ok) {
          showNotification('Products successfully unlinked!');
          selectedGroupProductIds.clear();
          updateUnlinkButtonState();

          // Refresh data
          await loadAdminData();
          // Since loadAdminData refreshes products but stays on tab, we just need to re-render groups
          displayGroups();
        } else {
          const data = await response.json();
          showNotification('Failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error(error);
        showNotification('Error unlinking products');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // Global variable to store current groups for selection logic
    let renderedGroups = [];

    function toggleWholeGroup(groupIndex) {
      const group = renderedGroups[groupIndex];
      if (!group) return;

      // Check if all are currently selected to determine toggle state (select all vs deselect all)
      const allSelected = group.every(p => selectedGroupProductIds.has(p._id || p.id));
      const newState = !allSelected;

      group.forEach(p => {
        const id = p._id || p.id;
        if (newState) {
          selectedGroupProductIds.add(id);
        } else {
          selectedGroupProductIds.delete(id);
        }
      });

      displayGroups(); // Re-render to update all checkboxes
    }

    function displayGroups() {
      const container = document.getElementById('groups-container');
      container.innerHTML = '';
      renderedGroups = []; // Reset

      // Find products that are part of a group
      const visitedIds = new Set();
      const groups = [];

      products.forEach(product => {
        const id = product._id || product.id;
        if (visitedIds.has(id)) return;

        if (product.colors && product.colors.length > 0) {
          const groupMembers = [product];
          visitedIds.add(id);

          product.colors.forEach(color => {
            if (!visitedIds.has(color.id)) {
              const linkedProduct = products.find(p => (p._id || p.id) == color.id);
              if (linkedProduct) {
                groupMembers.push(linkedProduct);
                visitedIds.add(color.id);
              }
            }
          });

          if (groupMembers.length > 0) {
            groups.push(groupMembers);
          }
        }
      });

      renderedGroups = groups; // Store for toggling

      if (groups.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No grouped products found. Use the Products tab to create groups.</div>';
        const unlinkBtn = document.getElementById('unlink-products-btn');
        if (unlinkBtn) unlinkBtn.style.display = 'none';
        return;
      }

      groups.forEach((group, index) => {
        const card = document.createElement('div');
        card.className = 'group-card';

        // Check if all items in this group are selected
        const isGroupSelected = group.every(p => selectedGroupProductIds.has(p._id || p.id));

        let html = `
                <div class="group-header">
                    <div class="group-title-wrapper">
                        <input type="checkbox" onchange="toggleWholeGroup(${index})" ${isGroupSelected ? 'checked' : ''} style="cursor: pointer; width: 18px; height: 18px;">
                        <h3 class="group-title">Group #${index + 1}</h3>
                        <span class="group-count">${group.length} Items</span>
                    </div>
                </div>
                <div class="group-items-grid">
            `;

        group.forEach(p => {
          const pid = p._id || p.id;
          const isSelected = selectedGroupProductIds.has(pid);
          // Only add 'selected' class if it's selected individually or as part of group logic tracking
          // The CSS handles the background color based on the class

          html += `
                    <div class="group-product-item ${isSelected ? 'selected' : ''}">
                        <div class="group-checkbox-wrapper">
                            <input type="checkbox" onchange="toggleGroupSelection('${pid}'); displayGroups();" ${isSelected ? 'checked' : ''} style="cursor: pointer; width: 18px; height: 18px;">
                        </div>
                        <img src="${p.image ? p.image.replace(/\\/g, '/') : ''}" class="group-item-image">
                        <div class="group-item-info">
                            <div class="group-item-name" title="${p.name}">${p.name}</div>
                            <div class="group-item-meta">ID: ${pid}</div>
                            <div class="group-item-meta">‚Çπ${p.price}</div>
                        </div>
                    </div>
                `;
        });

        html += `</div>`;
        card.innerHTML = html;
        container.appendChild(card);
      });

      updateUnlinkButtonState();
    }

    function updateGroupButtonState() {
      const btn = document.getElementById('group-products-btn');
      const countSpan = document.getElementById('selected-count');

      if (!btn || !countSpan) return;

      const count = selectedProductIds.size;
      countSpan.textContent = count;

      if (count >= 2) {
        btn.style.display = 'inline-block';
      } else {
        btn.style.display = 'none';
      }
    }

    async function groupSelectedProducts() {
      if (selectedProductIds.size < 2) return;

      if (!confirm(`Are you sure you want to link these ${selectedProductIds.size} products? This will overwrite their existing color links.`)) {
        return;
      }

      const btn = document.getElementById('group-products-btn');
      btn.disabled = true;
      btn.textContent = 'Linking...';

      try {
        const response = await fetch('/api/admin/products/group', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productIds: Array.from(selectedProductIds) })
        });

        if (response.ok) {
          showNotification('Products linked successfully!');
          selectedProductIds.clear();
          updateGroupButtonState();
          await loadAdminData(); // Refresh list
        } else {
          const data = await response.json();
          showNotification('Failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error(error);
        showNotification('Error linking products');
      } finally {
        btn.disabled = false;
        btn.innerHTML = `üîó Group Selected (<span id="selected-count">${selectedProductIds.size}</span>)`;
      }
    }

    function displayProducts() {
      const searchTerm = document.getElementById('product-search').value.toLowerCase();
      const categoryFilter = document.getElementById('category-filter').value;
      const tbody = document.getElementById('products-tbody');
      tbody.innerHTML = '';

      // Pre-calculate Groups to assign numbers (Group 1, Group 2, etc.) using ALL products
      // This ensures group numbers stay stable even when filtering
      const productGroupMap = new Map();
      let groupCount = 0;
      const processedForGroups = new Set();

      // Sort ALL products by creation date to have stable group numbers
      const allSortedProducts = [...products].sort((a, b) =>
        (a.createdAt && b.createdAt) ? new Date(a.createdAt) - new Date(b.createdAt) : 0
      );

      allSortedProducts.forEach(product => {
        const id = product._id || product.id;
        if (processedForGroups.has(id)) return;

        if (product.colors && product.colors.length > 0) {
          groupCount++;
          const groupName = `Group ${groupCount}`;

          // Mark current product
          productGroupMap.set(id, groupName);
          processedForGroups.add(id);

          // Mark linked products
          product.colors.forEach(color => {
            productGroupMap.set(color.id, groupName);
            processedForGroups.add(color.id);
          });
        }
      });

      // Filter products for display
      let visibleProducts = products;

      if (categoryFilter) {
        visibleProducts = visibleProducts.filter(p => p.category === categoryFilter);
      }

      if (searchTerm) {
        visibleProducts = visibleProducts.filter(p =>
          p.name.toLowerCase().includes(searchTerm) ||
          (p._id || p.id).toString().toLowerCase().includes(searchTerm)
        );
      }

      console.log('Displaying products:', visibleProducts.length);

      if (visibleProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">No products found</td></tr>';
        return;
      }

      // Group visible products by category
      const productsByCategory = visibleProducts.reduce((acc, product) => {
        const category = product.category;
        if (!acc[category]) {
          acc[category] = [];
        }
        acc[category].push(product);
        return acc;
      }, {});

      // Sort categories ensuring consistent order
      const sortedCategories = Object.keys(productsByCategory).sort();

      // Display products grouped by category
      sortedCategories.forEach(category => {
        // Sort products in this category by Name
        productsByCategory[category].sort((a, b) => a.name.localeCompare(b.name));

        // Add category header row
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `
      <td colspan="11" style="background-color: #f8f9fa; padding: 10px; font-weight: bold; color: #2c3e50; border-bottom: 2px solid #dee2e6;">
        üì¶ ${category} (${productsByCategory[category].length} products)
      </td>
    `;
        tbody.appendChild(headerRow);

        // Add products in this category
        productsByCategory[category].forEach(product => {
          const id = product._id || product.id;
          const isSelected = selectedProductIds.has(id);

          // Get Group Name
          let linkedInfo = '<span style="color: #999;">-</span>';
          if (productGroupMap.has(id)) {
            const groupName = productGroupMap.get(id);
            linkedInfo = `<span style="background: #e0e7ff; color: #4338ca; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${groupName}</span>`;
          }

          const row = document.createElement('tr');
          row.innerHTML = `
        <td>
            <input type="checkbox" 
                   onchange="toggleProductSelection('${id}')" 
                   ${isSelected ? 'checked' : ''} 
                   style="cursor: pointer; width: 18px; height: 18px;">
        </td>
        <td>${id}</td>
        <td>${product.name}</td>
        <td>${product.category}</td>
        <td>‚Çπ${product.price}</td>
        <td>
          ${product.sizes && Object.keys(product.sizes).length > 0 ?
              Object.entries(product.sizes).map(([size, qty]) => `<div><strong>${size}:</strong> ${qty}</div>`).join('') :
              product.stock}
        </td>
        <td>
          ${product.image ?
              `<img src="${product.image.replace(/\\/g, '/')}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
             <span style="color: #999; display: none;">No Image</span>` :
              '<span style="color: #999;">No Image</span>'
            }
        </td>
        <td>${linkedInfo}</td>
        <td>${product.description || '<span style="color: #999;">No Description</span>'}</td>
        <td>${product.createdAt ? new Date(product.createdAt).toLocaleDateString() : '<span style="color: #999;">N/A</span>'}</td>
        <td>
          <button class="btn-icon edit" title="Edit" onclick="editProduct('${id}')">‚úèÔ∏è</button>
          <button class="btn-icon stock" title="Add Stock" onclick="addStock('${id}')">üì¶</button>
          ${(!product.colors || product.colors.length === 0) ?
              `<button class="btn-icon colors" title="Link Colors" onclick="linkColors('${id}')">üé®</button>` :
              ''}
          <button class="btn-icon collection-toggle ${product.inCollection !== false ? 'active' : ''}" 
                  title="${product.inCollection !== false ? 'Remove from Collection' : 'Show in Collection'}" 
                  onclick="toggleCollectionStatus('${id}', ${product.inCollection !== false})">
            ${product.inCollection !== false ? 'üëÅÔ∏è' : 'üö´'}
          </button>
          <button class="btn-icon delete" title="Delete" onclick="deleteProduct('${id}')">üóëÔ∏è</button>
        </td>
      `;
          tbody.appendChild(row);
        });

        // Add spacing after each category
        const spacingRow = document.createElement('tr');
        spacingRow.innerHTML = '<td colspan="11" style="height: 20px;"></td>';
        tbody.appendChild(spacingRow);
      });
    }

    function displayUsers() {
      const searchTerm = document.getElementById('user-search') ? document.getElementById('user-search').value.toLowerCase() : '';
      const tbody = document.getElementById('users-tbody');
      tbody.innerHTML = '';

      let filteredUsers = users;

      if (searchTerm) {
        filteredUsers = filteredUsers.filter(u =>
          (u.firstName && u.firstName.toLowerCase().includes(searchTerm)) ||
          (u.lastName && u.lastName.toLowerCase().includes(searchTerm)) ||
          (u.email && u.email.toLowerCase().includes(searchTerm)) ||
          (u.phone && u.phone.includes(searchTerm))
        );
      }

      if (filteredUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">No users found</td></tr>';
        return;
      }

      filteredUsers.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
      <td>${user._id ? user._id.toString().substring(0, 8) + '...' : 'N/A'}</td>
      <td>${user.firstName || 'N/A'} ${user.lastName || ''}</td>
      <td>${user.email}</td>
      <td>${user.phone || 'N/A'}</td>
      <td><span class="status-badge ${user.type || 'user'}">${user.type || 'user'}</span></td>
      <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</td>
      <td>
        <button class="btn-icon view" title="View Details" onclick="viewUser('${user._id}')">üëÅÔ∏è</button>
        <button class="btn-icon edit" title="Edit" onclick="editUser('${user._id}')">‚úèÔ∏è</button>
        <button class="btn-icon delete" title="Delete" onclick="deleteUser('${user._id}')">üóëÔ∏è</button>
      </td>
    `;
        tbody.appendChild(row);
      });
    }

    function displayOrders() {
      const searchTerm = document.getElementById('order-search') ? document.getElementById('order-search').value.toLowerCase() : '';
      const statusFilterElem = document.getElementById('status-filter');
      const statusFilter = statusFilterElem ? statusFilterElem.value : '';
      const tbody = document.getElementById('orders-tbody');
      tbody.innerHTML = '';

      let filteredOrders = orders;

      // Apply status filter
      if (statusFilter) {
        filteredOrders = filteredOrders.filter(o => o.status === statusFilter);
      }

      // Apply search filter
      if (searchTerm) {
        filteredOrders = filteredOrders.filter(o =>
          (o.customerName && o.customerName.toLowerCase().includes(searchTerm)) ||
          (o.userName && o.userName.toLowerCase().includes(searchTerm)) ||
          (o.orderId && o.orderId.toLowerCase().includes(searchTerm)) ||
          (o.id && o.id.toString().includes(searchTerm)) ||
          (o._id && o._id.includes(searchTerm))
        );
      }

      if (filteredOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No orders found</td></tr>';
        return;
      }

      filteredOrders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
      <td><input type="checkbox" class="order-checkbox" value="${order._id}" onchange="updateBulkUpdateButton()"></td>
      <td>${order.orderId || '#' + (order._id || order.id)}</td>
      <td>${order.customerName || order.userName || 'Unknown'}</td>
      <td><div style="white-space: pre-line; line-height: 1.4;">${formatShippingAddress(order.shippingAddress).replace(/<br>/g, '\n')}</div></td>
      <td><span class="payment-method-badge">${formatPaymentMethod(order.paymentMethod, order)}</span></td>
      <td>‚Çπ${order.totalAmount || order.summary?.grandTotal || 0}</td>
      <td><span class="status-badge ${order.status || 'pending'}">${order.status || 'pending'}</span></td>
      <td>${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : new Date().toLocaleDateString()}</td>
      <td>
        <button class="btn-icon view" title="View Details" onclick="viewOrder('${order._id}')">üëÅÔ∏è</button>
        <button class="btn-icon delete" title="Delete" onclick="deleteOrder('${order._id}')">üóëÔ∏è</button>
      </td>
    `;
        tbody.appendChild(row);
      });

      updateBulkUpdateButton();
    }

    function loadOrders() {
      console.log('Fetching orders from /api/admin/orders...');

      fetch('/api/admin/orders')
        .then(response => {
          console.log('Orders response status:', response.status);
          if (response.ok) {
            return response.json();
          } else {
            const errorData = response.json();
            console.error('Failed to load orders:', errorData);
            throw new Error('Failed to load orders');
          }
        })
        .then(data => {
          orders = data;
          console.log('Orders loaded:', orders.length);
          console.log('Orders data:', orders);
          displayOrders();
          updateOrderStats();
        })
        .catch(error => {
          console.error('Error loading orders:', error);
          showNotification('Failed to load orders');
        });
    }

    function loadUsers() {
      console.log('Fetching users from /api/admin/users...');

      fetch('/api/admin/users')
        .then(response => {
          console.log('Users response status:', response.status);
          if (response.ok) {
            return response.json();
          } else {
            const errorData = response.json();
            console.error('Failed to load users:', errorData);
            throw new Error('Failed to load users');
          }
        })
        .then(data => {
          users = data;
          console.log('Users loaded:', users.length);
          console.log('Users data:', users);
          displayUsers();
        })
        .catch(error => {
          console.error('Error loading users:', error);
          showNotification('Failed to load users');
        });
    }

    function deleteOrder(orderId) {
      const order = orders.find(o => o._id === orderId);
      if (!order) return;

      if (!confirm(`Are you sure you want to delete order ${order.orderId || order._id}?`)) {
        return;
      }

      const token = localStorage.getItem('token') || sessionStorage.getItem('token');

      fetch(`/api/admin/orders/${orderId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.message) {
            showNotification('Order deleted successfully!');
            loadAdminData(); // Reload all data to update orders
          } else {
            showNotification('Error: ' + (data.error || 'Failed to delete order'));
          }
        })
        .catch(error => {
          console.error('Error deleting order:', error);
          showNotification('Failed to delete order');
        });
    }

    // Format payment method for display
    function formatPaymentMethod(method, order) {
      if (!method) return 'Not Specified';

      const methods = {
        'cod': 'üíµ Cash on Delivery',
        'card': 'üí≥ Credit/Debit Card',
        'upi': 'üì± UPI Payment'
      };

      let displayText = methods[method] || method;

      // Add UTR for UPI payments
      if (method === 'upi' && order && order.utrNumber) {
        displayText += `<br><small style="color: #64748b; font-weight: 600; font-size: 13px;">UTR: ${order.utrNumber}</small>`;
      }

      return displayText;
    }

    // Format shipping address for display
    function formatShippingAddress(address) {
      console.log('formatShippingAddress called with:', address); // Debug log

      if (!address) return 'No Address';

      // Build full address with all details line by line
      let addressLines = [];

      // Add name if available
      if (address.name) {
        addressLines.push(address.name);
      }

      // Add email if available
      if (address.email) {
        addressLines.push(`üìß ${address.email}`);
      }

      // Add phone if available
      if (address.phone) {
        addressLines.push(`üì± ${address.phone}`);
      }

      // Add house/flat number if available
      if (address.house) {
        addressLines.push(`üè† ${address.house}`);
      }

      // Add street address
      if (address.address || address.street) {
        addressLines.push(`üìç ${address.address || address.street}`);
      }

      // Add city, state, zip code
      const cityStateZip = [address.city, address.state, address.zipCode].filter(Boolean).join(', ');
      if (cityStateZip) {
        addressLines.push(`üèôÔ∏è ${cityStateZip}`);
      }

      // Add country
      if (address.country) {
        addressLines.push(`üåç ${address.country}`);
      }

      const result = addressLines.length > 0 ? addressLines.join('\n') : 'No Address';
      console.log('formatShippingAddress result:', result); // Debug log

      return result;
    }

    function exportOrders() {
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      if (!token) {
        alert('Admin access required');
        return;
      }

      // Create CSV content
      const csvContent = [
        ['Order ID', 'Customer Full Name', 'Email', 'Phone', 'Shipping Address', 'Payment Method', 'UTR Number', 'Total', 'Status', 'Date'],
        ...orders.map(order => [
          order.orderId || order._id,
          order.customerName || order.userName || 'Unknown',
          order.userEmail || '',
          order.userPhone || '',
          formatShippingAddress(order.shippingAddress),
          formatPaymentMethod(order.paymentMethod, order).replace(/<br>/g, ' ').replace(/<[^>]*>/g, ''), // Remove HTML tags
          order.paymentMethod === 'upi' && order.utrNumber ? order.utrNumber : '',
          order.totalAmount || order.summary?.grandTotal || 0,
          order.status || 'pending',
          order.createdAt ? new Date(order.createdAt).toLocaleDateString() : new Date().toLocaleDateString()
        ])
      ].map(row => row.join(',')).join('\n');

      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function exportProducts() {
      // Create CSV content
      const csvContent = [
        ['Product ID', 'Name', 'Category', 'Price', 'Stock', 'Description', 'Created Date'],
        ...products.map(product => [
          product._id || product.id,
          product.name,
          product.category,
          product.price || 0,
          product.stock || 0,
          (product.description || '').replace(/,/g, ';'), // Replace commas to avoid CSV issues
          product.createdAt ? new Date(product.createdAt).toLocaleDateString() : 'N/A'
        ])
      ].map(row => row.join(',')).join('\n');

      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `products_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function exportUsers() {
      // Create CSV content
      const csvContent = [
        ['User ID', 'First Name', 'Last Name', 'Email', 'Phone', 'Type', 'Joined Date'],
        ...users.map(user => [
          user._id || user.id,
          user.firstName || 'N/A',
          user.lastName || '',
          user.email,
          user.phone || 'N/A',
          user.type || 'user',
          user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'
        ])
      ].map(row => row.join(',')).join('\n');

      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function refreshOrders() {
      loadOrders();
    }

    function refreshUsers() {
      loadUsers();
    }

    function refreshProducts() {
      loadAdminData();
    }

    function refreshAnalytics() {
      // Reload analytics data
    }

    function updateOrderStats() {
      const totalOrders = orders.length;
      const totalRevenue = orders.reduce((sum, order) =>
        sum + (order.totalAmount || order.summary?.grandTotal || 0), 0
      );

      document.getElementById('total-orders').textContent = totalOrders;
      document.getElementById('total-revenue').textContent = '‚Çπ' + totalRevenue;
    }

    async function viewOrder(orderId) {
      console.log('Viewing order with ID:', orderId);

      try {
        // Fetch detailed order information
        const response = await fetch(`/api/admin/orders/${orderId}/details`);
        console.log('API response status:', response.status);

        if (!response.ok) {
          throw new Error(`Failed to fetch order details: ${response.status}`);
        }

        const orderDetails = await response.json();
        console.log('Order details fetched:', orderDetails);

        if (!orderDetails.items || orderDetails.items.length === 0) {
          console.warn('No items found in order details, checking local data...');
        }

        displayOrderDetails(orderDetails);

      } catch (error) {
        console.error('Error fetching order details:', error);
        showNotification('Failed to fetch order details, using local data...');

        // Fallback to local data if API fails
        const order = orders.find(o => o._id === orderId);
        console.log('Local order data:', order);

        if (order) {
          displayOrderDetails(order);
        } else {
          showNotification('Order not found');
        }
      }
    }

    function displayOrderDetails(order) {
      console.log('Displaying order details:', order);

      const content = document.getElementById('order-details-content');

      // Debug: Check if items exist
      console.log('Order items:', order.items);
      console.log('Items length:', order.items ? order.items.length : 'undefined');

      // Format order items with size information
      const itemsHtml = order.items && order.items.length > 0 ?
        order.items.map(item => {
          console.log('Processing item:', item);
          return `
      <div class="order-item-detail">
        <div class="item-info">
          <h4>${item.name || item.productName}</h4>
          ${item.size ? `<p class="item-size">Size: ${item.size}</p>` : ''}
          <p class="item-quantity">Quantity: ${item.quantity}</p>
          <p class="item-price">Price: ‚Çπ${item.price}</p>
        </div>
        <div class="item-total">
          <strong>‚Çπ${(item.price * item.quantity).toFixed(2)}</strong>
        </div>
      </div>
    `;
        }).join('') : '<p class="no-items">No items found</p>';

      console.log('Generated items HTML:', itemsHtml);

      // Format shipping address
      const shippingAddress = order.shippingAddress ? `
    <div class="address-section">
      <h4>üè† Shipping Address</h4>
      <p><strong>${order.shippingAddress.name}</strong></p>
      ${order.shippingAddress.email ? `<p>üìß ${order.shippingAddress.email}</p>` : ''}
      ${order.shippingAddress.phone ? `<p>üì± ${order.shippingAddress.phone}</p>` : ''}
      ${order.shippingAddress.house ? `<p>${order.shippingAddress.house}</p>` : ''}
      ${order.shippingAddress.street ? `<p>${order.shippingAddress.street}</p>` : ''}
      <p>${order.shippingAddress.city}, ${order.shippingAddress.state} ${order.shippingAddress.zipCode}</p>
      <p>${order.shippingAddress.country}</p>
    </div>
  ` : '<p class="no-address">No shipping address</p>';

      // Calculate totals
      const subtotal = order.items ? order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0) : 0;
      const codCharge = order.paymentMethod === 'cod' ? 10 : 0;
      const total = order.totalAmount || subtotal + codCharge;

      content.innerHTML = `
    <div class="order-details-container">
      <!-- Order Header -->
      <div class="order-header-section">
        <div class="order-info">
          <h3>Order #${order.orderId || order._id}</h3>
          <p><strong>Date:</strong> ${order.createdAt ? new Date(order.createdAt).toLocaleString() : 'N/A'}</p>
          <p><strong>Status:</strong> <span class="status-badge ${order.status || 'pending'}">${order.status || 'pending'}</span></p>
          <p><strong>Payment Method:</strong> ${formatPaymentMethod(order.paymentMethod, order)}</p>
          ${order.utrNumber ? `<p><strong>UTR Number:</strong> ${order.utrNumber}</p>` : ''}
        </div>
        <div class="customer-info">
          <h4>Customer Information</h4>
          <p><strong>Name:</strong> ${order.customerName || order.userName || 'Unknown'}</p>
          ${order.userEmail ? `<p><strong>Email:</strong> ${order.userEmail}</p>` : ''}
          ${order.userPhone ? `<p><strong>Phone:</strong> ${order.userPhone}</p>` : ''}
        </div>
      </div>
      
      <!-- Order Items -->
      <div class="order-items-section">
        <h3>üõçÔ∏è Order Items</h3>
        <div class="items-list">
          ${itemsHtml}
        </div>
      </div>
      
      <!-- Shipping Address -->
      <div class="shipping-section">
        ${shippingAddress}
      </div>
      
      <!-- Order Summary -->
      <div class="order-summary-section">
        <h3>üí∞ Order Summary</h3>
        <div class="summary-details">
          <div class="summary-row">
            <span>Subtotal:</span>
            <span>‚Çπ${subtotal.toFixed(2)}</span>
          </div>
          ${codCharge > 0 ? `
            <div class="summary-row">
              <span>Cash on Delivery Charge:</span>
              <span>‚Çπ${codCharge.toFixed(2)}</span>
            </div>
          ` : ''}
          <div class="summary-row total">
            <span><strong>Total Amount:</strong></span>
            <span><strong>‚Çπ${total.toFixed(2)}</strong></span>
          </div>
        </div>
      </div>
    </div>
  `;

      // Show modal
      document.getElementById('view-order-modal').style.display = 'flex';
    }

    function closeViewOrderModal() {
      document.getElementById('view-order-modal').style.display = 'none';
    }

    function printOrderDetails() {
      const content = document.getElementById('order-details-content').innerHTML;
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Order Details</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .order-header-section { margin-bottom: 20px; }
        .order-items-section { margin-bottom: 20px; }
        .shipping-section { margin-bottom: 20px; }
        .order-summary-section { margin-bottom: 20px; }
        .order-item-detail { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ddd; }
        .summary-row { display: flex; justify-content: space-between; padding: 5px 0; }
        .summary-row.total { border-top: 2px solid #333; font-weight: bold; }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .status-badge.pending { background: #ffc107; color: #856404; }
        .status-badge.processing { background: #17a2b8; color: white; }
        .status-badge.shipped { background: #6c757d; color: white; }
        .status-badge.delivered { background: #28a745; color: white; }
        @media print { body { margin: 10px; } }
      </style>
    </head>
    <body>
      ${content}
    </body>
    </html>
  `);
      printWindow.document.close();
      printWindow.print();
    }

    function updateOrderStatus(orderId) {
      const order = orders.find(o => o._id === orderId);
      if (!order) return;

      const newStatus = prompt('Update order status (pending/processing/shipped/delivered):', order.status);
      if (!newStatus) return;

      const newPaymentStatus = prompt('Update payment status (pending/paid):', order.paymentStatus);
      if (!newPaymentStatus) return;

      const token = localStorage.getItem('token') || sessionStorage.getItem('token');

      fetch(`/api/admin/orders/${orderId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          status: newStatus,
          paymentStatus: newPaymentStatus
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.message) {
            alert('Order updated successfully!');
            loadOrders(); // Reload orders
          } else {
            alert('Error: ' + (data.error || 'Failed to update order'));
          }
        })
        .catch(error => {
          console.error('Error updating order:', error);
          alert('Failed to update order');
        });
    }

    // Toggle all order checkboxes
    function toggleAllOrders() {
      const selectAllCheckbox = document.getElementById('select-all-orders');
      const orderCheckboxes = document.querySelectorAll('.order-checkbox');

      orderCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });

      updateBulkUpdateButton();
    }

    // Update bulk update button visibility
    function updateBulkUpdateButton() {
      const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
      const bulkUpdateBtn = document.getElementById('bulk-update-btn');

      if (selectedCheckboxes.length > 0) {
        bulkUpdateBtn.style.display = 'inline-block';
        bulkUpdateBtn.textContent = `üìù Update Selected (${selectedCheckboxes.length})`;
      } else {
        bulkUpdateBtn.style.display = 'none';
      }
    }

    // Bulk update selected orders
    function bulkUpdateOrders() {
      const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');

      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one order to update');
        return;
      }

      const selectedOrderIds = Array.from(selectedCheckboxes).map(cb => cb.value);

      // Create a simple modal for bulk update
      const modal = document.createElement('div');
      modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  `;

      modal.innerHTML = `
    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
      <h3 style="margin-bottom: 15px;">Bulk Update Orders</h3>
      <p style="margin-bottom: 15px;">Updating ${selectedOrderIds.length} order(s)</p>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Order Status:</label>
        <select id="bulk-order-status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">No Change</option>
          <option value="pending">Pending</option>
          <option value="processing">Processing</option>
          <option value="shipped">Shipped</option>
          <option value="delivered">Delivered</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 5px;">Payment Status:</label>
        <select id="bulk-payment-status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">No Change</option>
          <option value="pending">Pending</option>
          <option value="paid">Paid</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="this.closest('div[style*=position]').remove()" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
        <button onclick="executeBulkUpdate('${selectedOrderIds.join(',')}')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Update Orders</button>
      </div>
    </div>
  `;

      document.body.appendChild(modal);
    }

    // Execute bulk update
    function executeBulkUpdate(orderIds) {
      const orderStatus = document.getElementById('bulk-order-status').value;
      const paymentStatus = document.getElementById('bulk-payment-status').value;

      if (!orderStatus && !paymentStatus) {
        alert('Please select at least one field to update');
        return;
      }

      const updateData = {};
      if (orderStatus) updateData.status = orderStatus;
      if (paymentStatus) updateData.paymentStatus = paymentStatus;

      const token = localStorage.getItem('token') || sessionStorage.getItem('token');

      // Update each order individually
      const orderIdArray = orderIds.split(',');
      let updateCount = 0;

      Promise.all(orderIdArray.map(orderId => {
        return fetch(`/api/admin/orders/${orderId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(updateData)
        })
          .then(response => response.json())
          .then(data => {
            if (data.message) {
              updateCount++;
            }
            return data;
          });
      }))
        .then(results => {
          // Remove modal
          const modal = document.querySelector('div[style*="position: fixed"]');
          if (modal) modal.remove();

          // Show result
          if (updateCount > 0) {
            alert(`Successfully updated ${updateCount} order(s)!`);
            loadOrders(); // Reload orders

            // Clear checkboxes
            document.getElementById('select-all-orders').checked = false;
            updateBulkUpdateButton();
          } else {
            alert('Failed to update orders');
          }
        })
        .catch(error => {
          console.error('Error in bulk update:', error);
          alert('Failed to update orders');

          // Remove modal
          const modal = document.querySelector('div[style*="position: fixed"]');
          if (modal) modal.remove();
        });
    }

    // Link Colors Functions
    function linkColors(productId) {
      const product = products.find(p => (p._id || p.id) === productId);
      if (!product) return;

      document.getElementById('link-colors-product-id').value = productId;
      document.getElementById('link-colors-product-name').textContent = product.name;

      // Clear search
      const searchInput = document.getElementById('color-product-search');
      if (searchInput) searchInput.value = '';
      const resultsDiv = document.getElementById('color-search-results');
      if (resultsDiv) resultsDiv.style.display = 'none';

      const container = document.getElementById('color-links-container');
      container.innerHTML = '';

      // Populate existing colors if any
      if (product.colors && product.colors.length > 0) {
        product.colors.forEach(color => {
          addLinkColorRow(color.name, color.id);
        });
      } else {
        // Add current product as first option (Self-link) suggestion?
        // Let's just default to empty or maybe auto-add self? 
        // Better to leave empty and let user decide.
        addLinkColorRow(); // Empty row
      }

      document.getElementById('link-colors-modal').style.display = 'flex';
    }

    function searchProductsForColor(query) {
      const resultsDiv = document.getElementById('color-search-results');
      if (!query || query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
      }

      const lowerQuery = query.toLowerCase();
      // Filter products excluding current one? Optional.
      const matches = products.filter(p => p.name.toLowerCase().includes(lowerQuery));

      if (matches.length === 0) {
        resultsDiv.style.display = 'none';
        return;
      }

      resultsDiv.innerHTML = matches.map(p => `
            <div onclick="selectProductForColor('${p._id || p.id}', '${p.name.replace(/'/g, "\\'")}')" 
                 style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: background 0.2s;">
                <div style="font-weight: 500; font-size: 0.9rem;">${p.name}</div>
                <div style="font-size: 0.8rem; color: #64748b;">ID: ${p._id || p.id}</div>
            </div>
        `).join('');

      resultsDiv.style.display = 'block';
    }

    function selectProductForColor(id, name) {
      // Add a new row with this product
      // Suggest a short name? (e.g. part of the name?)
      // Let's us the full name as placeholder or default?
      // Usually we want just "Red" or "Blue". 
      // Let's leave name empty for user to fill, or prefill with full name.
      addLinkColorRow('', id);

      // Clear search
      document.getElementById('color-product-search').value = '';
      document.getElementById('color-search-results').style.display = 'none';
    }

    function closeLinkColorsModal() {
      document.getElementById('link-colors-modal').style.display = 'none';
    }

    function addLinkColorRow(name = '', id = '') {
      const container = document.getElementById('color-links-container');
      const div = document.createElement('div');
      div.className = 'color-link-row';
      div.style.display = 'flex';
      div.style.gap = '10px';
      div.style.marginBottom = '10px';

      div.innerHTML = `
        <input type="text" placeholder="Color Name (e.g. Red)" class="color-name-input" value="${name}" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <input type="text" placeholder="Product ID" class="product-id-input" value="${id}" style="flex: 1.5; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <button type="button" class="btn-icon delete" onclick="deleteLinkColorRow(this)" title="Remove">üóëÔ∏è</button>
      `;
      container.appendChild(div);
    }

    function deleteLinkColorRow(btn) {
      btn.parentElement.remove();
    }

    async function saveLinkedColors() {
      const productId = document.getElementById('link-colors-product-id').value;
      const container = document.getElementById('color-links-container');
      const rows = container.querySelectorAll('.color-link-row');

      const colors = [];
      rows.forEach(row => {
        const name = row.querySelector('.color-name-input').value.trim();
        const id = row.querySelector('.product-id-input').value.trim();
        if (name && id) {
          colors.push({ name, id });
        }
      });

      // Show loading state
      const saveBtn = document.querySelector('#link-colors-modal .btn-primary');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Saving...';
      saveBtn.disabled = true;

      try {
        const product = products.find(p => (p._id || p.id) === productId);
        // We need to preserve other fields, so we use the PUT endpoint which updates fields
        // But the PUT endpoint expects all fields or we need to merge?
        // Let's check the backend logic. The PUT endpoint updates fields provided in body.
        // But in server.js, we see:
        // const { name, category, price, image, description, stock, sizes, colors } = req.body;
        // And then it constructs updateData with these. Fields not provided might be undefined?
        // Wait, "name, category, price" are required in validation!
        // So we MUST provide them. 

        if (!product) throw new Error('Product not found locally');

        const updateData = {
          name: product.name,
          category: product.category,
          price: product.price,
          image: product.image,
          description: product.description,
          stock: product.stock,
          sizes: product.sizes,
          colors: colors
        };

        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const response = await fetch(`/api/admin/products/${productId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(updateData)
        });

        if (response.ok) {
          showNotification('Colors linked successfully!');
          closeLinkColorsModal();
          loadAdminData(); // Refresh data
        } else {
          const data = await response.json();
          throw new Error(data.error || 'Failed to update colors');
        }
      } catch (error) {
        console.error('Error saving colors:', error);
        showNotification('Error: ' + error.message);
      } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
    }

    async function toggleCollectionStatus(id, currentStatus) {
      // currentStatus is boolean (true if currently shown - passed from onclick)
      // We want to toggle it.
      const newStatus = !currentStatus;

      try {
        const product = products.find(p => (p._id || p.id) === id);
        if (!product) return;

        // We need to send full update data because PUT replaces or merges?
        // My backend implementation of PUT merges provided fields but requires name/category/price validation.
        // So I must provide those.

        const updateData = {
          name: product.name,
          category: product.category,
          price: product.price,
          image: product.image,
          description: product.description,
          stock: product.stock,
          sizes: product.sizes,
          colors: product.colors,
          inCollection: newStatus
        };

        const token = localStorage.getItem('token') || sessionStorage.getItem('token');

        // Optimize: Optimistic UI update could be done here, but reload is safer.
        const btn = document.querySelector(`button[onclick*="'${id}', ${currentStatus}"]`);
        if (btn) {
          btn.innerHTML = '...';
          btn.disabled = true;
        }

        const response = await fetch(`/api/admin/products/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(updateData)
        });

        if (response.ok) {
          showNotification(`Product ${newStatus ? 'added to' : 'removed from'} collection`);
          loadAdminData(); // Refresh to update UI
        } else {
          const data = await response.json();
          throw new Error(data.error || 'Failed to update content');
        }
      } catch (error) {
        console.error('Error toggling collection status:', error);
        showNotification('Error: ' + error.message);
        loadAdminData(); // Revert/Refresh
      }
    }

    // Load categories for product forms
    async function loadCategories() {
      try {
        console.log('Loading categories...');
        const response = await fetch('/api/categories');
        if (response.ok) {
          const categories = await response.json();
          console.log('Categories received:', categories);

          // Update add product modal dropdown
          const productCategory = document.getElementById('product-category');
          if (productCategory) {
            productCategory.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(category => {
              productCategory.innerHTML += `<option value="${category.name}">${category.name}</option>`;
            });
            console.log('Product category dropdown updated');
          }

          // Update edit product modal dropdown
          const editProductCategory = document.getElementById('edit-product-category');
          if (editProductCategory) {
            editProductCategory.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(category => {
              editProductCategory.innerHTML += `<option value="${category.name}">${category.name}</option>`;
            });
            console.log('Edit product category dropdown updated');
          }

          console.log('Categories loaded successfully:', categories);
        } else {
          console.error('Failed to load categories:', response.status);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    function showAddProductModal() {
      // Ensure categories are loaded
      loadCategories();

      // Reset form to default state
      document.getElementById('product-name').value = '';
      document.getElementById('product-category').value = '';
      document.getElementById('product-price').value = '';
      // document.getElementById('product-stock').value = ''; // Removed
      document.getElementById('product-description').value = '';
      document.getElementById('product-image').value = '';

      // Clear size rows and add one default row
      const sizeContainer = document.getElementById('size-stock-container');
      if (sizeContainer) {
        sizeContainer.innerHTML = `
      <div class="size-stock-row">
        <input type="text" placeholder="Size (e.g., S, M, L, XL)" class="size-name">
        <input type="number" placeholder="Stock" min="0" step="1" class="size-quantity">
        <button type="button" onclick="addSizeRow()" class="btn-add-size">+ Add Size</button>
      </div>
    `;
      }

      document.getElementById('add-product-modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('add-product-modal').style.display = 'none';
      // Clear form
      document.getElementById('product-name').value = '';
      document.getElementById('product-category').value = '';
      document.getElementById('product-price').value = '';
      // document.getElementById('product-stock').value = ''; // Removed
      document.getElementById('product-description').value = '';
      document.getElementById('product-image').value = '';

      // Clear size rows
      const sizeContainer = document.getElementById('size-stock-container');
      if (sizeContainer) {
        sizeContainer.innerHTML = ''; // Will be reset on open
      }
    }

    function closeEditModal() {
      document.getElementById('edit-product-modal').style.display = 'none';
      // Clear form
      document.getElementById('edit-product-id').value = '';
      document.getElementById('edit-product-name').value = '';
      document.getElementById('edit-product-category').value = '';
      document.getElementById('edit-product-price').value = '';
      // document.getElementById('edit-product-stock').value = ''; // Removed
      document.getElementById('edit-product-description').value = '';
      document.getElementById('edit-product-image').value = '';
    }

    // Close modals when clicking outside
    window.onclick = function (event) {
      const addModal = document.getElementById('add-product-modal');
      const editModal = document.getElementById('edit-product-modal');
      const addStockModal = document.getElementById('add-stock-modal');
      const addUserModal = document.getElementById('add-user-modal');
      const editUserModal = document.getElementById('edit-user-modal');
      const addCategoryModal = document.getElementById('add-category-modal');

      if (event.target === addModal) {
        addModal.style.display = 'none';
      }
      if (event.target === editModal) {
        editModal.style.display = 'none';
      }
      if (event.target === addStockModal) {
        addStockModal.style.display = 'none';
      }
      if (event.target === addUserModal) {
        addUserModal.style.display = 'none';
      }
      if (event.target === editUserModal) {
        editUserModal.style.display = 'none';
      }
      if (event.target === addCategoryModal) {
        addCategoryModal.style.display = 'none';
      }
    }

    async function addProduct(event) {
      event.preventDefault();

      // Ensure categories are loaded
      const categorySelect = document.getElementById('product-category');
      if (!categorySelect || categorySelect.options.length <= 1) {
        showNotification('Loading categories, please wait...');
        await loadCategories();
        return;
      }

      let sizes = {};
      let stock = 0;

      // Get size-wise stock - ALWAYS
      const sizeRows = document.querySelectorAll('#size-stock-container .size-stock-row');
      sizeRows.forEach(row => {
        const sizeName = row.querySelector('.size-name').value.trim();
        const sizeQuantity = parseInt(row.querySelector('.size-quantity').value) || 0;
        if (sizeName && sizeQuantity > 0) {
          sizes[sizeName] = sizeQuantity;
        }
      });

      // Calculate total stock
      stock = Object.values(sizes).reduce((sum, qty) => sum + qty, 0);

      if (Object.keys(sizes).length === 0) {
        if (!confirm('No stock sizes added. Do you want to add this product with 0 stock?')) {
          return;
        }
      }

      // Create FormData
      const formData = new FormData();
      formData.append('name', document.getElementById('product-name').value);
      formData.append('category', document.getElementById('product-category').value);
      formData.append('price', document.getElementById('product-price').value);
      formData.append('stock', stock);
      formData.append('description', document.getElementById('product-description').value);
      formData.append('image', document.getElementById('product-image').value); // Legacy path/URL
      formData.append('sizes', JSON.stringify(sizes));
      formData.append('colors', JSON.stringify([])); // Default empty colors for now
      formData.append('inCollection', 'true');

      // Append files
      const fileInput = document.getElementById('product-images');
      if (fileInput.files.length > 0) {
        for (let i = 0; i < fileInput.files.length; i++) {
          formData.append('images', fileInput.files[i]);
        }
      }

      // Validate required fields
      if (!document.getElementById('product-name').value || !document.getElementById('product-category').value || !document.getElementById('product-price').value) {
        showNotification('Please fill in all required fields (Name, Category, Price)');
        return;
      }

      // Show loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Adding...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/products', {
          method: 'POST',
          // Header 'Content-Type': 'multipart/form-data' is set automatically by browser when body is FormData
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Product created successfully:', result);
          showNotification('Product added successfully!');
          closeModal();

          // Reload data to show new product
          await loadAdminData();
        } else {
          const errorData = await response.json();
          console.error('Error response:', errorData);
          showNotification('Failed to add product: ' + (errorData.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error adding product:', error);
        showNotification('Error adding product: ' + error.message);
      } finally {
        // Restore button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    async function editProduct(id) {
      const product = products.find(p => (p._id || p.id) === id);
      if (!product) return;

      document.getElementById('edit-product-id').value = product._id || product.id;
      document.getElementById('edit-product-name').value = product.name;
      document.getElementById('edit-product-category').value = product.category;
      document.getElementById('edit-product-price').value = product.price;

      document.getElementById('edit-product-description').value = product.description || '';
      // document.getElementById('edit-product-image').value = product.image || ''; // Not used directly for display anymore

      // Populate existing images
      const imageContainer = document.getElementById('edit-current-images');
      imageContainer.innerHTML = '';

      let currentImages = product.images || (product.image ? [product.image] : []);

      currentImages.forEach((img, index) => {
        const imgDiv = document.createElement('div');
        imgDiv.className = 'edit-image-item';
        imgDiv.style.position = 'relative';
        imgDiv.style.width = '80px';
        imgDiv.style.height = '80px';
        imgDiv.innerHTML = `
            <img src="${img.replace(/\\/g, '/')}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">
            <button type="button" onclick="this.parentElement.remove()" style="position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">X</button>
            <input type="hidden" class="existing-image-val" value="${img}">
          `;
        imageContainer.appendChild(imgDiv);
      });

      // Determine stock type - Always Size-wise
      const hasSizes = product.sizes && Object.keys(product.sizes).length > 0;

      // Populate sizes
      const container = document.getElementById('edit-size-stock-container');
      container.innerHTML = '';

      if (hasSizes) {
        Object.keys(product.sizes).forEach(size => {
          const newRow = document.createElement('div');
          newRow.className = 'size-stock-row';
          newRow.innerHTML = `
            <input type="text" placeholder="Size (S, M...)" class="edit-size-name" value="${size}">
            <input type="number" placeholder="Qty" min="0" step="1" class="edit-size-quantity" value="${product.sizes[size]}">
            <button type="button" onclick="removeSizeRow(this)" class="btn-icon delete" title="Remove Size">üóëÔ∏è</button>
          `;
          container.appendChild(newRow);
        });
      } else {
        // Legacy single stock -> convert to "One Size" logic or just show total if needed?
        // Let's assume we want to convert it to "One Size" for editing
        const legacyStock = product.stock || 0;
        const newRow = document.createElement('div');
        newRow.className = 'size-stock-row';
        newRow.innerHTML = `
            <input type="text" placeholder="Size (S, M...)" class="edit-size-name" value="One Size">
            <input type="number" placeholder="Qty" min="0" step="1" class="edit-size-quantity" value="${legacyStock}">
            <button type="button" onclick="removeSizeRow(this)" class="btn-icon delete" title="Remove Size">üóëÔ∏è</button>
          `;
        container.appendChild(newRow);
      }

      // Ensure at least one add, if completely empty for some reason
      if (!container.hasChildNodes()) {
        // Should be covered by else above, but safe guard
      }

      document.getElementById('edit-product-modal').style.display = 'flex';
    }

    async function updateProduct(event) {
      event.preventDefault();

      const id = document.getElementById('edit-product-id').value;
      let sizes = {};
      let stock = 0;

      // Always get size-wise stock
      const sizeRows = document.querySelectorAll('#edit-size-stock-container .size-stock-row');
      sizeRows.forEach(row => {
        const sizeName = row.querySelector('.edit-size-name').value.trim();
        const sizeQuantity = parseInt(row.querySelector('.edit-size-quantity').value) || 0;
        if (sizeName && sizeQuantity > 0) {
          sizes[sizeName] = sizeQuantity;
        }
      });

      // Calculate total stock
      stock = Object.values(sizes).reduce((sum, qty) => sum + qty, 0);

      // Validate at least one size/stock
      if (Object.keys(sizes).length === 0) {
        if (!confirm('No sizes specified. Update product with 0 stock?')) {
          return;
        }
      }

      // Collect existing images
      const existingImages = [];
      document.querySelectorAll('#edit-current-images .existing-image-val').forEach(input => {
        existingImages.push(input.value);
      });

      // Validate required fields client-side
      const nameVal = document.getElementById('edit-product-name').value;
      const catVal = document.getElementById('edit-product-category').value;
      const priceVal = document.getElementById('edit-product-price').value;

      console.log('Client-side update check:', { nameVal, catVal, priceVal });

      if (!nameVal || !catVal || !priceVal) {
        alert(`Please fill all required fields. Missing: ${!nameVal ? 'Name ' : ''}${!catVal ? 'Category ' : ''}${!priceVal ? 'Price' : ''}`);
        return;
      }

      // Create FormData
      const formData = new FormData();
      formData.append('name', nameVal);
      formData.append('category', catVal);
      formData.append('price', priceVal);
      // ... continue with other fields
      formData.append('stock', stock);
      formData.append('description', document.getElementById('edit-product-description').value);
      formData.append('sizes', JSON.stringify(sizes));
      formData.append('colors', JSON.stringify([]));
      formData.append('inCollection', 'true');

      // Append existing images
      existingImages.forEach(img => {
        formData.append('existingImages', img);
      });

      // Append new files
      const fileInput = document.getElementById('edit-product-images');
      if (fileInput.files.length > 0) {
        for (let i = 0; i < fileInput.files.length; i++) {
          formData.append('images', fileInput.files[i]);
        }
      }

      // Show loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Updating...';
      submitBtn.disabled = true;

      try {
        const response = await fetch(`/api/admin/products/${id}`, {
          method: 'PUT',
          // No Content-Type header for FormData
          body: formData
        });

        if (response.ok) {
          await loadAdminData();
          closeEditModal();
          showNotification('Product updated successfully!');
        } else {
          const errorData = await response.json();
          showNotification('Failed to update product: ' + (errorData.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error updating product:', error);
        showNotification('Error updating product: ' + error.message);
      } finally {
        // Restore button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    // Add Stock Functions
    function closeAddStockModal() {
      document.getElementById('add-stock-modal').style.display = 'none';
      // Clear form
      document.getElementById('add-stock-product-id').value = '';
      document.getElementById('add-stock-product-name').value = '';
      // document.getElementById('add-stock-quantity').value = ''; // Removed
      document.getElementById('current-stock-display').innerHTML = '';
      document.getElementById('add-size-stock-container').innerHTML = '';
      // Reset is implied since we only have one view now
    }

    // toggleAddStockType removed

    function addSizeStockRow() {
      const container = document.getElementById('add-size-stock-container');
      const newRow = document.createElement('div');
      newRow.className = 'size-stock-row';
      newRow.innerHTML = `
    <input type="text" placeholder="Size (S, M...)" class="add-size-name" required>
    <input type="number" placeholder="Add Qty" min="0" step="1" class="add-size-quantity" required>
    <button type="button" onclick="removeSizeStockRow(this)" class="btn-icon delete" title="Remove Row">üóëÔ∏è</button>
  `;
      container.appendChild(newRow);
    }

    function removeSizeStockRow(button) {
      button.parentElement.remove();
    }

    async function addStock(id) {
      const product = products.find(p => (p._id || p.id) === id);
      if (!product) return;

      // Populate modal with product data
      document.getElementById('add-stock-product-id').value = product._id || product.id;
      document.getElementById('add-stock-product-name').value = product.name;

      // Display current stock (always show breakdown if sizes exist, or total if not)
      const currentStockDisplay = document.getElementById('current-stock-display');
      let stockHtml = '';

      if (product.sizes && Object.keys(product.sizes).length > 0) {
        stockHtml = '<div style="font-weight: 600; margin-bottom: 8px;">Current Size-wise Stock:</div>';
        Object.keys(product.sizes).forEach(size => {
          stockHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
        <span>${size}:</span>
        <span style="font-weight: 600;">${product.sizes[size]} units</span>
      </div>`;
        });
      } else {
        stockHtml = `<div style="display: flex; justify-content: space-between;">
      <span>Total Stock:</span>
      <span style="font-weight: 600;">${product.stock || 0} units</span>
    </div>`;
      }
      currentStockDisplay.innerHTML = stockHtml;

      // Force multiple stock view
      // Populate with existing sizes for convenience, or empty row
      const container = document.getElementById('add-size-stock-container');
      container.innerHTML = '';

      if (product.sizes && Object.keys(product.sizes).length > 0) {
        Object.keys(product.sizes).forEach(size => {
          const newRow = document.createElement('div');
          newRow.className = 'size-stock-row';
          newRow.innerHTML = `
        <input type="text" placeholder="Size (S, M...)" class="add-size-name" value="${size}" required>
        <input type="number" placeholder="Add Qty" min="0" step="1" class="add-size-quantity">
        <button type="button" onclick="removeSizeStockRow(this)" class="btn-icon delete" title="Remove Row">üóëÔ∏è</button>
      `;
          container.appendChild(newRow);
        });
      }

      // If no sizes, add one empty row
      if (!container.hasChildNodes()) {
        addSizeStockRow();
      }

      document.getElementById('add-stock-modal').style.display = 'flex';
    }

    async function updateStock(event) {
      event.preventDefault();

      console.log('Update Stock function called!'); // Debug log

      const productId = document.getElementById('add-stock-product-id').value;

      // Force stock type 'multiple'

      console.log('Product ID:', productId);

      if (!productId) {
        alert('Product ID not found. Please try again.');
        return;
      }

      let stockUpdate = {};

      // Size-wise stock addition
      const sizeRows = document.querySelectorAll('#add-size-stock-container .size-stock-row');
      console.log('Size rows found:', sizeRows.length);

      if (sizeRows.length === 0) {
        alert('Please add at least one size with quantity');
        return;
      }

      sizeRows.forEach(row => {
        const size = row.querySelector('.add-size-name').value.trim();
        const quantity = parseInt(row.querySelector('.add-size-quantity').value) || 0;
        console.log('Size:', size, 'Quantity:', quantity);

        if (size && quantity > 0) {
          stockUpdate[size] = quantity;
        }
      });

      console.log('Final stock update:', stockUpdate); // Debug log

      if (Object.keys(stockUpdate).length === 0) {
        alert('Please enter stock quantity to add');
        return;
      }


      // Disable submit button to prevent double submission
      const submitBtn = document.querySelector('#add-stock-modal button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Adding Stock...';
      submitBtn.disabled = true;

      try {
        console.log('Sending request to API...'); // Debug log

        // Show loading state
        showNotification('Adding stock to database...');

        const response = await fetch(`/api/admin/products/${productId}/add-stock`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ stockUpdate })
        });

        console.log('Response status:', response.status); // Debug log
        console.log('Response headers:', response.headers); // Debug log

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Error response:', errorData); // Debug log
          throw new Error(errorData.error || 'Failed to update stock');
        }

        const result = await response.json();
        console.log('API response:', result); // Debug log

        // Show success message with details
        showNotification(`Stock updated successfully! Total stock: ${result.totalStock || 'N/A'}`);

        // Close modal and refresh data
        closeAddStockModal();
        await loadAdminData();

      } catch (error) {
        console.error('Error updating stock:', error);
        showNotification('Failed to update stock: ' + error.message);
      } finally {
        // Restore button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    async function deleteProduct(id) {
      if (confirm('Are you sure you want to delete this product?')) {
        try {
          const response = await fetch(`/api/admin/products/${id}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            await loadAdminData();
            showNotification('Product deleted successfully!');
          } else {
            showNotification('Failed to delete product');
          }
        } catch (error) {
          console.error('Error deleting product:', error);
          showNotification('Error deleting product');
        }
      }
    }

    function searchProducts() {
      displayProducts();
    }

    function filterProducts() {
      displayProducts();
    }

    function searchUsers() {
      displayUsers();
    }

    function searchOrders() {
      displayOrders();
    }

    function filterOrders() {
      displayOrders();
    }

    function viewUser(userId) {
      const user = users.find(u => u._id === userId);
      if (user) {
        const userInfo = `
      üë§ User Profile Information
      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      Name: ${user.firstName || 'N/A'} ${user.lastName || ''}
      Email: ${user.email}
      Phone: ${user.phone || 'N/A'}
      Newsletter: ${user.newsletter ? 'Subscribed' : 'Not subscribed'}
      Joined: ${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}
    `;
        showNotification(userInfo);
      } else {
        showNotification('User not found');
      }
    }

    async function deleteUser(userId) {
      if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        try {
          const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            await loadAdminData();
            showNotification('User deleted successfully!');
          } else {
            showNotification('Failed to delete user');
          }
        } catch (error) {
          console.error('Error deleting user:', error);
          showNotification('Error deleting user');
        }
      }
    }

    // Category Management Functions
    function showAddCategoryModal() {
      document.getElementById('add-category-modal').style.display = 'flex';
    }

    function closeCategoryModal() {
      document.getElementById('add-category-modal').style.display = 'none';
      // Clear form
      document.getElementById('category-name').value = '';
      document.getElementById('category-description').value = '';
    }

    async function addCategory(event) {
      event.preventDefault();

      const categoryName = document.getElementById('category-name').value.trim();
      const categoryDescription = document.getElementById('category-description').value.trim();

      try {
        const response = await fetch('/api/admin/categories', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: categoryName,
            description: categoryDescription
          })
        });

        if (response.ok) {
          const result = await response.json();
          showNotification('Category added successfully!');
          closeCategoryModal();

          // Update all category dropdowns immediately with the new categories
          updateCategoryDropdownsWithData(result.categories);

          // Select the newly added category in the product form
          document.getElementById('product-category').value = categoryName;

        } else {
          const error = await response.json();
          showNotification(error.error || 'Failed to add category');
        }
      } catch (error) {
        console.error('Error adding category:', error);
        showNotification('Error adding category');
      }
    }

    // Update category dropdowns with data from API
    function updateCategoryDropdownsWithData(categories) {
      const productCategory = document.getElementById('product-category');
      const editProductCategory = document.getElementById('edit-product-category');
      const categoryFilter = document.getElementById('category-filter');

      // Update add product modal dropdown
      productCategory.innerHTML = '<option value="">Select Category</option>';
      categories.forEach(category => {
        productCategory.innerHTML += `<option value="${category.name}">${category.name}</option>`;
      });

      // Update edit product modal dropdown
      editProductCategory.innerHTML = '<option value="">Select Category</option>';
      categories.forEach(category => {
        editProductCategory.innerHTML += `<option value="${category.name}">${category.name}</option>`;
      });

      // Update filter dropdown
      categoryFilter.innerHTML = '<option value="">All Categories</option>';
      categories.forEach(category => {
        categoryFilter.innerHTML += `<option value="${category.name}">${category.name}</option>`;
      });
    }

    // User Management Functions
    function showAddUserModal() {
      document.getElementById('add-user-modal').style.display = 'flex';
    }

    function closeUserModal() {
      document.getElementById('add-user-modal').style.display = 'none';
      // Clear form
      document.getElementById('user-first-name').value = '';
      document.getElementById('user-last-name').value = '';
      document.getElementById('user-email').value = '';
      document.getElementById('user-phone').value = '';
      document.getElementById('user-password').value = '';
      document.getElementById('user-type').value = 'user';
    }

    async function addUser(event) {
      event.preventDefault();

      const newUser = {
        firstName: document.getElementById('user-first-name').value.trim(),
        lastName: document.getElementById('user-last-name').value.trim(),
        email: document.getElementById('user-email').value.trim(),
        phone: document.getElementById('user-phone').value.trim(),
        password: document.getElementById('user-password').value,
        type: document.getElementById('user-type').value
      };

      // Show loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Adding...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/admin/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(newUser)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('User created successfully:', result);
          showNotification('User added successfully!');
          closeUserModal();

          // Reload data to show new user
          await loadAdminData();
        } else {
          const errorData = await response.json();
          showNotification('Failed to add user: ' + (errorData.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error adding user:', error);
        showNotification('Error adding user: ' + error.message);
      } finally {
        // Restore button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    // Edit User Functions
    function editUser(userId) {
      const user = users.find(u => u._id === userId);
      if (!user) return;

      document.getElementById('edit-user-id').value = user._id;
      document.getElementById('edit-user-first-name').value = user.firstName || '';
      document.getElementById('edit-user-last-name').value = user.lastName || '';
      document.getElementById('edit-user-email').value = user.email || '';
      document.getElementById('edit-user-phone').value = user.phone || '';
      document.getElementById('edit-user-password').value = '';
      document.getElementById('edit-user-type').value = user.type || 'user';

      document.getElementById('edit-user-modal').style.display = 'flex';
    }

    function closeEditUserModal() {
      document.getElementById('edit-user-modal').style.display = 'none';
      // Clear form
      document.getElementById('edit-user-id').value = '';
      document.getElementById('edit-user-first-name').value = '';
      document.getElementById('edit-user-last-name').value = '';
      document.getElementById('edit-user-email').value = '';
      document.getElementById('edit-user-phone').value = '';
      document.getElementById('edit-user-password').value = '';
      document.getElementById('edit-user-type').value = 'user';
    }

    async function updateUser(event) {
      event.preventDefault();

      const id = document.getElementById('edit-user-id').value;
      const updatedUser = {
        firstName: document.getElementById('edit-user-first-name').value.trim(),
        lastName: document.getElementById('edit-user-last-name').value.trim(),
        email: document.getElementById('edit-user-email').value.trim(),
        phone: document.getElementById('edit-user-phone').value.trim(),
        type: document.getElementById('edit-user-type').value
      };

      // Only include password if it's provided
      const password = document.getElementById('edit-user-password').value;
      if (password) {
        updatedUser.password = password;
      }

      // Show loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Updating...';
      submitBtn.disabled = true;

      try {
        const response = await fetch(`/api/admin/users/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedUser)
        });

        if (response.ok) {
          await loadAdminData();
          closeEditUserModal();
          showNotification('User updated successfully!');
        } else {
          const errorData = await response.json();
          showNotification('Failed to update user: ' + (errorData.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error updating user:', error);
        showNotification('Error updating user: ' + error.message);
      } finally {
        // Restore button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    // Size-wise stock management functions
    // toggleStockType and toggleEditStockType removed

    function addSizeRow() {
      const container = document.getElementById('size-stock-container');
      const newRow = document.createElement('div');
      newRow.className = 'size-stock-row';
      newRow.innerHTML = `
    <input type="text" placeholder="Size (S, M, L...)" class="size-name" required>
    <input type="number" placeholder="Qty" min="0" step="1" class="size-quantity" required>
    <button type="button" onclick="removeSizeRow(this)" class="btn-icon delete" title="Remove Size">üóëÔ∏è</button>
  `;
      container.appendChild(newRow);
    }

    function addEditSizeRow() {
      const container = document.getElementById('edit-size-stock-container');
      const newRow = document.createElement('div');
      newRow.className = 'size-stock-row';
      newRow.innerHTML = `
    <input type="text" placeholder="Size (S, M, L...)" class="edit-size-name" required>
    <input type="number" placeholder="Qty" min="0" step="1" class="edit-size-quantity" required>
    <button type="button" onclick="removeSizeRow(this)" class="btn-icon delete" title="Remove Size">üóëÔ∏è</button>
  `;
      container.appendChild(newRow);
    }

    function removeSizeRow(button) {
      button.parentElement.remove();
    }
  </script>
  </style>
</body>

</html>